---
title: "Choice Test"
output:
  html_document:
    df_print: paged
---

```{r packages and theme, include = FALSE}
library(tidyverse) # graphs and pipes
library(car) # Anova test
library(broom) # to use the augment function
library(ggpubr) # to arrange multiple plots
library(AER) # testing for overdispersion
library(glmtoolbox) # test gvif
library(betareg) # beta regressions
library(lmtest) # to run likelihood ratio test 
library(emmeans) # joint test of terms in a model
library(DHARMa) # run dispersion tests
library(knitr) # to use the kable function
library(effects) # get predictions for single variables when interaction
library(mgcv) # for running beta regression with gam
library(mgcViz) # for testing dispersion of beta regression
library(broom.mixed) # to use augment for glm.nb
library(ggbreak) # add break in axis
library(glmmTMB) # repeated measures beta regression
library(buildmer) # backwards selection for beta regression
library(lme4) # to run glmer.nb
library(MASS) # negative binomial
library(multcomp) # multiple comparisons
library(FactoMineR) # to run PCA
library(factoextra) # to make PCA plot
library(corrplot) # build pca correlation plot

# global theme for the graphs
th <- theme_classic() +
  theme(text = element_text(size = 11, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.title = element_text(size = 11, color = "black"))

options(scipen = 100, digits = 4)
```

```{r import data, include = FALSE, warning = FALSE, message = FALSE}
choice <- read.csv("data/choice.csv", header = TRUE) %>% 
  mutate(Origin = as.factor(Origin), 
         # change origin from loud and quiet ot urban and rural
         Origin = fct_recode(Origin, "Urban" = "Loud", "Rural" = "Quiet"),
         # put rural first
         Origin = fct_relevel(Origin, "Rural", "Urban"),
         # categorize site
         Site = factor(Site),
         # orders sites in increasing noise order
         Site = fct_relevel(Site, "5A", "6C", "8A", "8B"),
         # give sites a continuous variable from 1 to 4 
         Site_ord = ifelse(Site == "6C", 1, 
                        ifelse(Site == "5A", 2, 
                               ifelse(Site == "8A", 3, 4))), 
         # since it isn't clear whether 6C or 5A should go first, let's also flip them
         Site_ord2 = ifelse(Site == "6C", 2, 
                        ifelse(Site == "5A", 1, 
                               ifelse(Site == "8A", 3, 4))), 
         # let's use the molt day as 1 day old instead of 0 days old
         Age = Age + 1,
         # mass is given as grams; let's convert them to milligrams
         mass_mg = before_spider_mass * 1000,
         # to calculate condition, we need log mass and log cephalothorax width
         log_mass_mg = log(mass_mg), 
         log_ceph_mm = log(ceph_width_mm)) %>% 
  # make the side with more silk a binary variable where loud is 1 and quiet is 0
  mutate(side = ifelse(side_w_more == "loud", 1, 0),
         # add associated site average Leq with each site
         mean_leq = ifelse(Site == "5A", -69,
                           ifelse(Site == "6C", -69,
                                  ifelse(Site == "8A", -64, -55))),
         # correct each silk measure (in micrograms) by volume
         loud_silk_v = (loud_silk * 1000) / 413.34,
         quiet_silk_v = (quiet_silk * 1000) / 413.34,
         tunnel_silk_v = (tunnel_silk * 1000) / 39.208,
         # get proportion of silk in loud (excluding tunnel)
         propl = loud_silk / (loud_silk + quiet_silk),
         # get proportion of silk in loud (with tunnel)
         propl_tunnel = loud_silk / (loud_silk + quiet_silk + tunnel_silk),
         proplv = loud_silk_v / (loud_silk_v + quiet_silk_v + tunnel_silk_v),
         # get proportion of silk in quiet (with tunnel)
         propq_tunnel = quiet_silk / (loud_silk + quiet_silk + tunnel_silk),
         propqv = quiet_silk_v / (loud_silk_v + quiet_silk_v + tunnel_silk_v),
         # get proportion of silk in tunnel
         propt_tunnel = tunnel_silk / (loud_silk + quiet_silk + tunnel_silk),
         proptv = tunnel_silk_v / (loud_silk_v + quiet_silk_v + tunnel_silk_v),
         # get proportional difference between sides (without tunnel)
         prop_diff = abs(propl - (1 - propl)),
         # get proportional difference between side (with tunnel)
         prop_diff_tunnel = abs(propl_tunnel - propq_tunnel),
         # total silk on loud and quiet side
         total_micro = (loud_silk + quiet_silk) * 1000,
         # total silk including tunnel
         total_micro_tunnel = (loud_silk + quiet_silk + tunnel_silk) * 1000,
         # assign 1 if left side has more silk or 0 if right
         side_lr = ifelse(side_w_more == left, 1, 0))

# Site subsets
choice_8B <- choice %>% 
  filter(Site == "8B")
choice_8A <- choice %>% 
  filter(Site == "8A")
choice_6C <- choice %>% 
  filter(Site == "6C")
choice_5A <- choice %>% 
  filter(Site == "5A")

# calculates spider condition - the residuals of the linear model with log mass and log cephalothorax width
rownames(choice) <- c(choice$ID)
cond <- data.frame(cbind(condition = residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice)),
                         ID = names(residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice)))))
# add condition to the choice dataset
choice <- full_join(choice, cond, by = "ID") %>% 
  mutate(condition = as.numeric(condition))

#now subsets
#8B
rownames(choice_8B) <- c(choice_8B$ID)
cond_8B <- data.frame(cbind(condition = residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_8B)),
                         ID = names(residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_8B)))))
choice_8B <- full_join(choice_8B, cond_8B, by = "ID") %>% 
  mutate(condition = as.numeric(condition))
#8A
rownames(choice_8A) <- c(choice_8A$ID)
cond_8A <- data.frame(cbind(condition = residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_8A)),
                         ID = names(residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_8A)))))
choice_8A <- full_join(choice_8A, cond_8A, by = "ID") %>% 
  mutate(condition = as.numeric(condition))
#6C
rownames(choice_6C) <- c(choice_6C$ID)
cond_6C <- data.frame(cbind(condition = residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_6C)),
                         ID = names(residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_6C)))))
choice_6C <- full_join(choice_6C, cond_6C, by = "ID") %>% 
  mutate(condition = as.numeric(condition))
#5A
rownames(choice_5A) <- c(choice_5A$ID)
cond_5A <- data.frame(cbind(condition = residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_5A)),
                         ID = names(residuals(lm(log_mass_mg ~ log_ceph_mm, data = choice_5A)))))
choice_5A <- full_join(choice_5A, cond_5A, by = "ID") %>% 
  mutate(condition = as.numeric(condition))

choice <- choice %>% 
  # order the variables nicely
  dplyr::select(ID, Site, Site_ord, Site_ord2, Origin,  Age, condition, Attack_time, Web_height, Sub_height, web_prop, Web_Length, Web_Width, Web_Area, collect_mass_mg, mean_leq, side_w_more, side, side_lr, propl, propl_tunnel, propq_tunnel, propt_tunnel, proplv, propqv, proptv, total_micro, total_micro_tunnel, loud_silk, quiet_silk, tunnel_silk, loud_silk_v, quiet_silk_v, tunnel_silk_v, prop_diff, prop_diff_tunnel, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side)

choice_8B <- choice_8B %>% 
  # order the variables nicely
  dplyr::select(ID, Site, Site_ord, Site_ord2, Origin,  Age, condition, mean_leq, side_w_more, side, side_lr, propl, propl_tunnel, propq_tunnel, propt_tunnel, proplv, propqv, proptv, total_micro, total_micro_tunnel, loud_silk, quiet_silk, tunnel_silk, loud_silk_v, quiet_silk_v, tunnel_silk_v, prop_diff, prop_diff_tunnel, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side)

choice_8A <- choice_8A %>% 
  # order the variables nicely
  dplyr::select(ID, Site, Site_ord, Site_ord2, Origin,  Age, condition, mean_leq, side_w_more, side, side_lr, propl, propl_tunnel, propq_tunnel, propt_tunnel, proplv, propqv, proptv, total_micro, total_micro_tunnel, loud_silk, quiet_silk, tunnel_silk, loud_silk_v, quiet_silk_v, tunnel_silk_v, prop_diff, prop_diff_tunnel, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side)

choice_6C <- choice_6C %>% 
  # order the variables nicely
  dplyr::select(ID, Site, Site_ord, Site_ord2, Origin,  Age, condition, mean_leq, side_w_more, side, side_lr, propl, propl_tunnel, propq_tunnel, propt_tunnel, proplv, propqv, proptv, total_micro, total_micro_tunnel, loud_silk, quiet_silk, tunnel_silk, loud_silk_v, quiet_silk_v, tunnel_silk_v, prop_diff, prop_diff_tunnel, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side)

choice_5A <- choice_5A %>% 
  # order the variables nicely
  dplyr::select(ID, Site, Site_ord, Site_ord2, Origin,  Age, condition, mean_leq, side_w_more, side, side_lr, propl, propl_tunnel, propq_tunnel, propt_tunnel, proplv, propqv, proptv, total_micro, total_micro_tunnel, loud_silk, quiet_silk, tunnel_silk, loud_silk_v, quiet_silk_v, tunnel_silk_v, prop_diff, prop_diff_tunnel, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side)
```

```{r pca spider features, include = FALSE, warning = FALSE, message = FALSE}
pca <- read.table("data/pca_choice.txt", header = TRUE)
colnames(pca) <- c('Age','Cephalothorax Width','Abdomen Width', 'Mass', 'Site')
pca <- pca[, c(1:5)]
choice.pca <- PCA(pca[,1:4], graph = FALSE)

fviz_eig(choice.pca, addlabels = TRUE)
var <- get_pca_var(choice.pca)
colnames(var$cos2) <- c("PC1", "PC2", "PC3", "PC4")
rownames(var$cos2) <- c("Age", "Ceph. Width", "Abdomen Width", "Mass")
corrplot(var$cos2, is.corr=FALSE, tl.col = "black", addCoef.col = 1, number.cex = 0.5, tl.cex = 0.5, cl.cex = 0.5)

fviz_pca_biplot(choice.pca,
                repel = TRUE,
                fill.ind = pca$Site,
                col.ind = pca$Site,
                labelsize = 3,
                pointsize = 2.0,
                pointshape = 21,
                axes.linetype = "dotted",
                mean.point = FALSE,
                col.var = "grey40",
                xlab = "Principal Component 1 (60.8%)",
                ylab = "Principal Component 2 (26.4%)",
                title = "",
                ggtheme = theme_classic() + 
                  theme(text = element_text(size = 10))) +
  scale_color_manual(name = "Site", labels = c("5A", "6C", "8A", "8B"),
                 values= c("#D95F02","#febd8c", "#90ecd1", "#1B9E77")) +
  scale_fill_manual(name = "Site", labels = c("5A", "6C", "8A", "8B"),
                 values= c("#D95F02","#febd8c", "#90ecd1", "#1B9E77")) +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(colour = "black", size = 10, family = "sans")) +
  theme(axis.text.y = element_text(colour = "black", size = 10, family = "sans")) +
  theme(axis.title.x = element_text(colour = "black", size = 10, family = "sans")) +
  theme(axis.title.y = element_text(colour = "black", size = 10, family = "sans")) 

dims <- data.frame(choice.pca$ind$coord)
pca_fixed <- pca 
pca_fixed$ID <- rownames(pca)
rownames(pca_fixed) <- NULL
dims$ID <- rownames(dims)
rownames(dims) <- NULL
pca_choice_results <- full_join(pca_fixed, dims, by = "ID") %>% 
  dplyr::select(ID, Dim.1)
pca_choice_results
```

```{r build spider dataset, echo = FALSE, warning = FALSE, message = FALSE}
choice_spider <- choice %>% 
  dplyr::select(ID, Site, Origin, mean_leq,  Age, condition, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side) %>% 
  # make four rows for each spider, one for each day
  pivot_longer(cols = day1_spider_side:day4_spider_side, values_to = "side_lq", names_to = "day") %>%
  mutate(day = fct_recode(day, "1" = "day1_spider_side", "2" = "day2_spider_side", "3" = "day3_spider_side", "4" = "day4_spider_side"),
         day = as.numeric(day)) 
choice_spider <- full_join(choice_spider, pca_choice_results, by = "ID")
choice <- full_join(choice, pca_choice_results, by = "ID")

choice_spider_8B <- choice_8B %>% 
  dplyr::select(ID, Site, Origin, mean_leq,  Age, condition, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side) %>% 
  # make four rows for each spider, one for each day
  pivot_longer(cols = day1_spider_side:day4_spider_side, values_to = "side_lq", names_to = "day") %>%
  mutate(day = fct_recode(day, "1" = "day1_spider_side", "2" = "day2_spider_side", "3" = "day3_spider_side", "4" = "day4_spider_side"),
         day = as.numeric(day)) 

choice_spider_8A <- choice_8A %>% 
  dplyr::select(ID, Site, Origin, mean_leq,  Age, condition, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side) %>% 
  # make four rows for each spider, one for each day
  pivot_longer(cols = day1_spider_side:day4_spider_side, values_to = "side_lq", names_to = "day") %>%
  mutate(day = fct_recode(day, "1" = "day1_spider_side", "2" = "day2_spider_side", "3" = "day3_spider_side", "4" = "day4_spider_side"),
         day = as.numeric(day)) 

choice_spider_6C <- choice_6C %>% 
  dplyr::select(ID, Site, Origin, mean_leq,  Age, condition, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side) %>% 
  # make four rows for each spider, one for each day
  pivot_longer(cols = day1_spider_side:day4_spider_side, values_to = "side_lq", names_to = "day") %>%
  mutate(day = fct_recode(day, "1" = "day1_spider_side", "2" = "day2_spider_side", "3" = "day3_spider_side", "4" = "day4_spider_side"),
         day = as.numeric(day)) 

choice_spider_5A <- choice_5A %>% 
  dplyr::select(ID, Site, Origin, mean_leq,  Age, condition, day1_spider_side, day2_spider_side, day3_spider_side, day4_spider_side) %>% 
  # make four rows for each spider, one for each day
  pivot_longer(cols = day1_spider_side:day4_spider_side, values_to = "side_lq", names_to = "day") %>%
  mutate(day = fct_recode(day, "1" = "day1_spider_side", "2" = "day2_spider_side", "3" = "day3_spider_side", "4" = "day4_spider_side"),
         day = as.numeric(day)) 
```

Let's first see if there are differences in age and body condition between sites and within sites. 

```{r age and cond btwn sites, echo = FALSE, message = FALSE, warning = FALSE}
#ggplot(aes(x = condition, color = Site), data = choice) +
#  geom_density()
#shapiro.test(choice$condition) # good
cond_site <- lm(condition ~ Site, data = choice)
Anova(cond_site) # trend
summary(glht(cond_site, linfct = mcp("Site" = "Tukey"))) # no signif, 8A higher
#cond_leq <- lm(condition ~ factor(mean_leq), data = choice)
#Anova(cond_leq) 
#lsmeans(cond_leq, pairwise ~ mean_leq) # 8A higher
#cond_org <- lm(condition ~ Origin, data = choice)
#Anova(cond_org)
#lsmeans(cond_org, pairwise ~ Origin) # no diff

choice_mean <- choice %>% 
  group_by(Site) %>% 
  summarize(mean = mean(condition),
            se = plotrix::std.error(condition))
ggplot() +
  geom_violin(aes(x = Site, y = condition), data = choice, trim = FALSE) +
  geom_jitter(aes(x = Site, y = condition), data = choice, color = "grey20", alpha = 0.75, width = 0.25) +
  geom_point(aes(x = Site, y = mean), data = choice_mean, color = "red") +
  geom_errorbar(aes(x = Site, y = mean, ymax = mean + se, ymin = mean - se), data = choice_mean, width = 0.25, color = "red") +
  th

#ggplot(aes(x = Age, color = Site), data = choice) +
#  geom_density()
#shapiro.test(choice$Age) # good
age_site <- lm(Age ~ Site, data = choice)
Anova(age_site) # no dif
#age_leq <- lm(Age ~ factor(mean_leq), data = choice)
#Anova(age_leq) # no dif
#age_org <- lm(Age ~ Origin, data = choice)
#Anova(age_org) # no dif

choice_mean2 <- choice %>% 
  group_by(Site) %>% 
  summarize(mean = mean(Age),
            se = plotrix::std.error(Age))
ggplot() +
  geom_violin(aes(x = Site, y = Age), data = choice, trim = FALSE) +
  geom_jitter(aes(x = Site, y = Age), data = choice, color = "grey20", alpha = 0.75, width = 0.25) +
  geom_point(aes(x = Site, y = mean), data = choice_mean2, color = "red") +
  geom_errorbar(aes(x = Site, y = mean, ymax = mean + se, ymin = mean - se), data = choice_mean2, width = 0.25, color = "red") +
  th

choice_scaled <- choice %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)))
age_cond <- lm(Age ~ condition, data = choice_scaled)
summary(age_cond)

ggplot(aes(x = Age, y = condition), data = choice) +
  geom_point() +
  geom_smooth(method = "lm") +
  th

#ggplot(aes(x = scale(Dim.1, scale = FALSE), color = Site), data = choice) +
#  geom_density()
#dim_site <- lm(Dim.1 ~ Site, data = choice)
#Anova(dim_site) 
#lsmeans(dim_site, pairwise ~ Site) # no diff
#dim_leq <- lm(Dim.1 ~ factor(mean_leq), data = choice)
#Anova(dim_leq)
#lsmeans(dim_leq, pairwise ~ mean_leq) # no dif
#dim_org <- lm(Dim.1 ~ Origin, data = choice)
#Anova(dim_org)
#lsmeans(dim_org, pairwise ~ Origin) # no diff
```

There is a trend that spiders from site 8A are in better condition than spiders from 8B and 6C, but not 5A. There are no differences in mean age at trial by site. There is a significant positive relationship between condition and age - i.e. older spiders are in better condition.

Let's see the spread within sites when we make condition relative to each site instead of overall. 

```{r exploring condition relative to site, echo = FALSE, message = FALSE, warning = FALSE}
#ggplot(aes(x = condition), data = choice_8B) +
#  geom_density()

#ggplot(aes(x = condition), data = choice_8A) +
#  geom_density()

#ggplot(aes(x = condition), data = choice_6C) +
#  geom_density()

#ggplot(aes(x = condition), data = choice_5A) +
#  geom_density()

rbind(choice_8B, choice_8A, choice_6C, choice_5A) %>% 
ggplot() +
  geom_violin(aes(x = Site, y = condition), trim = FALSE) +
  geom_jitter(aes(x = Site, y = condition), color = "grey20", alpha = 0.75, width = 0.25) +
  th
```

Let's look for differences in field measurements between sites. 

```{r field measurements, echo = FALSE, message = FALSE, warning = FALSE}
choice <- choice %>% 
  mutate(attack = ifelse(Attack_time < 30, 1, 0))
fit <- survfit(Surv(Attack_time, attack) ~ Site, data = choice)
print(fit)
survdiff(Surv(Attack_time, attack) ~ Site, data = choice)
survminer::ggsurvplot(fit,
           pval = TRUE, #conf.int = TRUE,
           pval.size = 5,
           #risk.table = TRUE, # Add risk table
           #risk.table.col = "strata", # Change risk table color by groups
           linetype = 1, # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("#666666", "#1b9e77", "#7570b3", "#d95f02"),
           ylab = "Proportion that have not attacked",
           font.x = c(16, "bold", "black"),
           font.y = c(16, "bold", "black"),
           font.tickslab = c(12, "plain", "black"),
           font.legend = c(12, "plain", "black"),
           legend.title = "Site",
           legend = "right")

#height <- glm.nb(web_prop ~ Site, data = choice)
height <- betareg(web_prop ~ Site, data = choice)
Anova(height)
emmeans(height, pairwise ~ Site, type = "response")
#summary(glht(height, mcp(Site="Tukey")))
height2 <- glm.nb(Web_height ~ Site, data = choice)
Anova(height2)
emmeans(height2, pairwise ~ Site, type = "response")

choice_mean <- choice %>% 
group_by(Site) %>% 
  summarize(mean = mean(web_prop),
            se = plotrix::std.error(web_prop))
ggplot() +
  geom_violin(aes(x = Site, y = web_prop), data = choice, trim = FALSE) +
  geom_jitter(aes(x = Site, y = web_prop), data = choice, color = "grey20", alpha = 0.75, width = 0.25) +
  geom_point(aes(x = Site, y = mean), data = choice_mean, color = "red") +
  geom_errorbar(aes(x = Site, y = mean, ymax = mean + se, ymin = mean - se), data = choice_mean, width = 0.25, color = "red") +
  th

choice_mean2 <- choice %>% 
group_by(Site) %>% 
  summarize(mean = mean(Web_height),
            se = plotrix::std.error(Web_height))
ggplot() +
  geom_violin(aes(x = Site, y = Web_height), data = choice, trim = FALSE) +
  geom_jitter(aes(x = Site, y = Web_height), data = choice, color = "grey20", alpha = 0.75, width = 0.25) +
  geom_point(aes(x = Site, y = mean), data = choice_mean2, color = "red") +
  geom_errorbar(aes(x = Site, y = mean, ymax = mean + se, ymin = mean - se), data = choice_mean2, width = 0.25, color = "red") +
  th
  
choice <- choice %>% 
  mutate(area_corrected = Web_Area / collect_mass_mg)
area <- glm.nb(area_corrected ~ Site, data = choice)
Anova(area)
emmeans(area, pairwise ~ Site, type = "response")
area2 <- glm.nb(Web_Area ~ Site, data = choice)
Anova(area2)

choice_mean <- choice %>% 
group_by(Site) %>% 
  summarize(mean = mean(area_corrected),
            se = plotrix::std.error(area_corrected))
ggplot() +
  geom_violin(aes(x = Site, y = area_corrected), data = choice, trim = FALSE) +
  geom_jitter(aes(x = Site, y = area_corrected), data = choice, color = "grey20", alpha = 0.75, width = 0.25) +
  geom_point(aes(x = Site, y = mean), data = choice_mean, color = "red") +
  geom_errorbar(aes(x = Site, y = mean, ymax = mean + se, ymin = mean - se), data = choice_mean, width = 0.25, color = "red") +
  th
```

No differences in attack rates between sites. Spiders from site 8A built significantly higher webs than spiders from 6C and 5A (not 8B). There was an overall difference in web area across sites, but pairwise comparison reveal only a trend that 6C webs were bigger than site 8B when corrected by body mass. No differences when not corrected by mass. 

# The Spider's Position

Where the spider is located during the day may help us determine where the spiders likes to spend its time. We recorded the position of the spider between 10:00 and 15:00 everyday for four days, which occurs during their mostly inactive period. Personal observations have shown that they move very little during the day, often sitting deep in the retreat or at the opening.

Let's look at the raw data. 

```{r visualize raw data, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
#ordered by feature
choice_spider %>% 
  mutate(ID = factor(ID),
    Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B"),
    side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_tile(aes(x = day, y = reorder(ID, Dim.1), fill = side_lq), alpha = 0.9) +
  xlab("Day of Trial") +
  ylab("Spider ID") +
  scale_fill_manual("Chamber Part",
                    values = c("#d95f02", "#1b9e77", "#666666")) +
  th +
  facet_wrap(~Site, scales = "free")

#ordered by Age
choice_spider %>% 
  mutate(ID = factor(ID),
    Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B"),
    side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_tile(aes(x = day, y = reorder(ID, Age), fill = side_lq), alpha = 0.9) +
  xlab("Day of Trial") +
  ylab("Spider ID") +
  scale_fill_manual("Chamber Part",
                    values = c("#d95f02", "#1b9e77", "#666666")) +
  th +
  facet_wrap(~Site, scales = "free")

#ordered by condition
choice_spider %>% 
  mutate(ID = factor(ID),
    Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B"),
    side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_tile(aes(x = day, y = reorder(ID, condition), fill = side_lq), alpha = 0.9) +
  xlab("Day of Trial") +
  ylab("Spider ID") +
  scale_fill_manual("Chamber Part",
                    values = c("#d95f02", "#1b9e77", "#666666")) +
  th +
  facet_wrap(~Site, scales = "free")

choice_spider %>% 
  group_by(Site, Origin, day, side_lq) %>% 
  count() %>% 
  mutate(side_lq = factor(side_lq), 
         side_lq = fct_relevel(side_lq, "tunnel", "quiet", "loud"),
         Site = factor(Site), 
         Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B")) %>% 
  ggplot() +
  geom_bar(aes(x = day, y = n, fill = side_lq), position="fill", stat="identity") + 
  xlab("Day") +
  ylab("Proportion of Spiders in Each Part by Day") +
  scale_fill_manual("Chamber Part",
                    values = c("#666666", "#1b9e77", "#d95f02"),
                    labels = c("Tunnel" , "Quiet", "Loud")) +
  th +
  facet_wrap(~Site)
```

Only two spiders were found in the tunnel all four days.

## Stayed all four days

**tl;dr:** When we used a binomial regression to assess the probability of staying all four days (1) and moving (0), an interaction between leq and condition was retained in the model but was not significant. Spiders from the loudest site (8B) were more likely to stay in one place when they were younger. 

### Raw Data

Let's start by looking at whether spiders were found in the same chamber part all four days or not. First, let's look at the raw data.

```{r stayed or moved by leq, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
stay_longer <- choice_spider %>% 
  group_by(ID, Site, Origin, mean_leq, side_lq, Dim.1, Age, condition) %>% 
  count() %>% 
  #if a spider was found in the same part for all four days = 1, else 0
  mutate(stay = ifelse(n == 4, 1, 0))

stay <- stay_longer[!duplicated(stay_longer[ , "ID"]), ]

# sorted by condition
stay %>% 
  mutate(ID = factor(ID),
    Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B")) %>% 
ggplot() +
  geom_tile(aes(x = 1, y = reorder(ID, condition), fill = factor(stay)), alpha = 0.9) +
  xlab("") +
  ylab("Spider ID") +
  scale_fill_manual("Stayed",
                    values = c("grey", "#7570b3")) +
  th +
  ggtitle("By condition") +
  theme(axis.text.x = element_blank()) +
  facet_wrap(~Site, scales = "free")

# sorted by age
stay %>% 
  mutate(ID = factor(ID),
    Site = fct_recode(Site, "Site 5A" = "5A", "Site 6C" = "6C", "Site 8A" = "8A", "Site 8B" = "8B")) %>% 
ggplot() +
  geom_tile(aes(x = 1, y = reorder(ID, Age), fill = factor(stay)), alpha = 0.9) +
  xlab("") +
  ylab("Spider ID") +
  scale_fill_manual("Stayed",
                    values = c("grey", "#7570b3")) +
  th +
  ggtitle("By age") +
  theme(axis.text.x = element_blank()) +
  facet_wrap(~Site, scales = "free")

# count the number of spiders that stayed or moved
stay %>% 
  group_by(Site, Origin, stay) %>% 
  count() %>% 
  mutate(stay = factor(stay),
         stay = fct_relevel(stay, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = Site, y = n, fill = stay), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("grey", "#7570b3"),
                    labels = c("Moved", "Stayed")) +
  th +
  ggtitle("Stay or Move by Site") +
  theme(legend.position = "top")

# mean_leq
stay %>% 
  group_by(mean_leq, stay) %>% 
  count() %>% 
  mutate(stay = factor(stay),
         stay = fct_relevel(stay, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = stay), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("grey", "#7570b3"),
                    labels = c("Moved", "Stayed")) +
  th +
  ggtitle("Stay or Move by Leq") +
  theme(legend.position = "top")

stay_age_raw <- stay %>% 
  ggplot() +
  geom_jitter(aes(x = Age, y = stay, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = Age, y = stay), color = "black", se = FALSE) +
  th +
  theme(legend.position = "top") +
  ggtitle("Stay by Age")

stay_condition_raw <- stay %>% 
  ggplot() +
  geom_jitter(aes(x = condition, y = stay, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = condition, y = stay), color = "black", se = FALSE) +
  th +
  theme(legend.position = "top") +
  ggtitle("Stay by Condition")

stay_mean_leq_raw <- stay %>% 
  group_by(mean_leq, stay) %>% 
  count() %>% 
  mutate(stay = factor(stay),
         stay = fct_relevel(stay, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = stay), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("grey", "#7570b3"),
                    labels = c("Moved", "Stayed")) +
  th +
  theme(legend.position = "top")

ggarrange(stay_age_raw, stay_condition_raw, stay_mean_leq_raw, nrow = 2, ncol = 2)
```

### Stats and Assumptions

Let's see what predicts whether a spider stays in the same part all four days. We will use a binomial regression since we can code the data as stayed all four days (1) or moved at least once (0). Since we know age and condition are positively correlated, we will avoid using interactions between age and condition and we will double check the VIF of the final model after backward selection. All data appear linear, so let's not include any polynomials. We will scale and center all continuous variables. 

```{r stay stats and assumptions for leq, echo = FALSE, message = FALSE, warning = FALSE}
stay_scaled <- stay %>% 
  ungroup() %>% 
  mutate(Dim.1 = c(scale(Dim.1)),
         mean_leq = c(scale(mean_leq)),
         Age = c(scale(Age)),
         condition = c(scale(condition)),
         side_lq = factor(side_lq)) 

# staying versus not staying
stay.binom <- glm(stay ~  mean_leq * Age + mean_leq * condition, data = stay_scaled, family = binomial)
stay.binom <- step(stay.binom)
#drop1(stay.binom, test = "Chisq")
#stay.binom2 <- update(stay.binom, .~. -mean_leq:Age)
#drop1(stay.binom2, test = "Chisq")
#stay.binom3 <- update(stay.binom2, .~. -Age)
#drop1(stay.binom3, test = "Chisq")
#stay.binom4 <- update(stay.binom3, .~. -mean_leq:condition)
#drop1(stay.binom4, test = "Chisq") 
#stay.binom5 <- update(stay.binom4, .~. -condition)
#drop1(stay.binom5, test = "Chisq")
#stay.binom6 <- update(stay.binom5, .~. -mean_leq)
#drop1(stay.binom6, test = "Chisq")
summary(stay.binom)
with(summary(stay.binom), 1 - deviance/null.deviance)
#emtrends(stay.binom, pairwise ~ mean_leq, var = "Age", at = list(mean_leq = quantile(stay_scaled$mean_leq, probs = c(0.25, 0.5, 0.75))))

test_stay <- augment(stay.binom, data = stay_scaled)
resid_stay <- ggplot(test_stay, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_stay$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_stay <- ggplot(test_stay, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

test_stay$.std.resid <- residuals(stay.binom, type = "deviance")
scale_loc_stay <- ggplot(test_stay, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_stay <- ggplot(test_stay, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()

annotate_figure(ggarrange(resid_stay, qq_stay, scale_loc_stay, cook_stay,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Stay Binomial"))

model.data <- augment(stay.binom) %>% 
  mutate(index = 1:n()) 
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers

vif(stay.binom)
#no multicolinearity
```

An interaction between leq and condition are retained in the model, but it is not significant.
Let's look for relationships within each site. 

```{r stay stats and assumptions for sites, include = FALSE, message = FALSE, warning = FALSE}
stay_8B <- choice_spider_8B %>% 
  group_by(ID, Site, Origin, mean_leq, side_lq, Age, condition) %>% 
  count() %>% 
  #if a spider was found in the same part for all four days = 1, else 0
  mutate(stay = ifelse(n == 4, 1, 0))
stay_8B <- stay_8B[!duplicated(stay_8B[ , "ID"]), ]
stay_8B_scaled <- stay_8B %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)),
         side_lq = factor(side_lq))

stay.binom.8b <- glm(stay ~ Age + condition, data = stay_8B_scaled, family = binomial)
stay.binom.8b <- step(stay.binom.8b)
summary(stay.binom.8b)
#Anova(stay.binom.8b, test.statistic = "Wald")
with(summary(stay.binom.8b), 1 - deviance/null.deviance)
# Age
ggplot(aes(x = Age, y = stay), data = stay_8B) +
  geom_point() +
  geom_smooth(method = "lm") +
  th

stay_8A <- choice_spider_8A %>% 
  group_by(ID, Site, Origin, mean_leq, side_lq, Age, condition) %>% 
  count() %>% 
  #if a spider was found in the same part for all four days = 1, else 0
  mutate(stay = ifelse(n == 4, 1, 0))
stay_8A <- stay_8A[!duplicated(stay_8A[ , "ID"]), ]
stay_8A_scaled <- stay_8A %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)),
         side_lq = factor(side_lq)) 

stay.binom.8a <- glm(stay ~ Age + condition, data = stay_8A_scaled, family = binomial)
stay.binom.8a <- step(stay.binom.8a) 
summary(stay.binom.8a)
#Anova(stay.binom.8a, test.statistic = "Wald") # age but not signif
ggplot(aes(x = Age, y = stay), data = stay_8A) +
  geom_point() +
  geom_smooth(method = "lm") +
  th

stay_6C <- choice_spider_6C %>% 
  group_by(ID, Site, Origin, mean_leq, side_lq, Age, condition) %>% 
  count() %>% 
  #if a spider was found in the same part for all four days = 1, else 0
  mutate(stay = ifelse(n == 4, 1, 0))
stay_6C <- stay_6C[!duplicated(stay_6C[ , "ID"]), ]
stay_6C_scaled <- stay_6C %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)),
         side_lq = factor(side_lq)) 

stay.binom.6c <- glm(stay ~ Age + condition, data = stay_6C_scaled, family = binomial)
stay.binom.6c <- step(stay.binom.6c)
summary(stay.binom.6c)
#Anova(stay.binom.6c, test.statistic = "Wald") # none

stay_5A <- choice_spider_5A %>% 
  group_by(ID, Site, Origin, mean_leq, side_lq, Age, condition) %>% 
  count() %>% 
  #if a spider was found in the same part for all four days = 1, else 0
  mutate(stay = ifelse(n == 4, 1, 0))
stay_5A <- stay_5A[!duplicated(stay_5A[ , "ID"]), ]
stay_5A_scaled <- stay_5A %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)),
         side_lq = factor(side_lq))

stay.binom.5a <- glm(stay ~ condition + Age, data = stay_5A_scaled, family = binomial)
stay.binom.5a <- step(stay.binom.5a)
summary(stay.binom.5a)
#Anova(stay.binom.5a, test.statistic = "Wald") # nothing
```

Age mattered for spiders from the loudest site (8B), but not the rest (although it was retained for the second loudest site - 8A). Spiders from site 8B became increasingly less likely to stay in place as they aged. 

### Graph 

```{r stay graph, eval = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
# predictions for a bunch of quantiles
pred <- expand.grid(mean_leq = seq(-1, 1.4, 0.02),
                  condition = quantile(stay_scaled$condition, probs = c(seq(0, 1, 0.1))))
pred <- add_column(pred, fit = data.frame(predict(stay.binom, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(stay.binom, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(stay$mean_leq) + mean(stay$mean_leq)
pred$condition = pred$condition * sd(stay$condition) + mean(stay$condition)

# preditions for quantiles 0, 0.5, and 1
pred2 <- expand.grid(mean_leq = seq(-1, 1.4, 0.02),
                  condition = quantile(stay_scaled$condition, probs = c(0, 0.5, 1)))
pred2 <- add_column(pred2, fit = data.frame(predict(stay.binom, newdata = pred2, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(stay.binom, newdata = pred2, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred2$mean_leq = pred2$mean_leq * sd(stay$mean_leq) + mean(stay$mean_leq)
pred2$condition = pred2$condition * sd(stay$condition) + mean(stay$condition)

ggplot() +
  geom_ribbon(aes(x = mean_leq, y = fit, ymin = fit - (1 * se), ymax = fit + (1 * se), group = condition, color = condition, fill = condition), data = pred2, alpha = 0.65) +
  geom_jitter(aes(x = mean_leq, y = stay, color = condition), data = stay, width = 1, height = 0.05, alpha = 1, size = 1) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  #geom_line(aes(x = mean_leq, y = fit, group = condition, color = condition), data = pred, linewidth = 0.5) +
  geom_line(aes(x = mean_leq, y = fit, group = condition, color = condition), data = pred2, linewidth = 1) +
  scale_fill_viridis_c(limits = c(-0.35, 0.3), breaks = c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3), name = "Body Condition", option = "plasma", direction = 1) +
  scale_color_viridis_c(limits = c(-0.35, 0.3), breaks = c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3), name = "Body Condition", option = "plasma", direction = 1) +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  ylab("Proportion of Spiders \nthat Stayed Four Days") +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  th +
  theme(legend.position = "top")



pred <- expand.grid(mean_leq = quantile(stay_scaled$mean_leq, probs = c(0, 0.5, 1)),
                  condition = seq(-2.3, 2.1, 0.1))
pred <- add_column(pred, fit = data.frame(predict(stay.binom, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(stay.binom, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(stay$mean_leq) + mean(stay$mean_leq)
pred$condition = pred$condition * sd(stay$condition) + mean(stay$condition)

stay_move <- ggplot() +
  geom_line(aes(x = condition, y = fit, group = factor(mean_leq), color = factor(mean_leq)), data = pred, linewidth = 1) +
  geom_ribbon(aes(x = condition, y = fit, ymin = fit - (1 * se), ymax = fit + (1 * se), group = factor(mean_leq), color = factor(mean_leq), fill = factor(mean_leq)), data = pred, alpha = 0.65) +
  geom_jitter(aes(x = condition, y = stay, color = factor(mean_leq)), data = stay, height = 0.05, alpha = 1, size = 1) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  scale_fill_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  xlab("Body Condition (Residuals of Body Mass and Cephalothorax Width)") +
  ylab("Proportion of Spiders \nthat Stayed Four Days") +
  th +
  theme(legend.position = "top")


jpeg("figures/stay_move.jpeg", width = 3.5, height = 3, units = "in", quality = 100, res = 300)
print(stay_move)
dev.off()
stay_move
```

## Those that Stayed - Loud or Quiet

**tl;dr:** When we used a binomial regression to assess the probability of staying in the loud (1) or quiet (0) side, condition was retained in the model but was not significant. Age and condition did not significantly predict staying on a particular side within sites. 

Let's also look at those that stayed and what side they chose (loud or quiet). 

### Raw Data

Check out the raw data.

```{r stayed side, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
stay %>% 
  filter(stay == 1) %>% 
  group_by(Site, Origin, side_lq) %>% 
  count() %>% 
  mutate(side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_bar(aes(x = Site, y = n, fill = side_lq), position="fill", stat="identity") +
  xlab("Site") +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Chamber Part", 
                    values = c("#d95f02", "#1b9e77", "#666666"),
                    labels = c("Loud" , "Quiet", "Tunnel")) +
  th +
  ggtitle("With Tunnel") +
  theme(legend.position = "top")

stay %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  group_by(Site, Origin, side_lq) %>% 
  count() %>% 
  mutate(side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet")) %>% 
ggplot() +
  geom_bar(aes(x = Site, y = n, fill = side_lq), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  xlab("Site") +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Chamber Part", 
                    values = c("#d95f02", "#1b9e77"),
                    labels = c("Loud" , "Quiet")) +
  th +
  ggtitle("Without Tunnel") +
  theme(legend.position = "top")

stay %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  group_by(mean_leq, Origin, side_lq) %>% 
  count() %>% 
  mutate(side_lq = factor(side_lq),
         side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = side_lq), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Chamber Part", 
                    values = c("#d95f02", "#1b9e77"),
                    labels = c("Loud" , "Quiet")) +
  th +
  ggtitle("Leq Without Tunnel") +
  theme(legend.position = "top")

stay_side_age_raw <- stay %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  mutate(side = ifelse(side_lq == "loud", 1, 0)) %>% 
  ggplot() +
  geom_jitter(aes(x = Age, y = side, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = Age, y = side), color = "black", se = FALSE) +
  th +
  theme(legend.position = "top") +
  ggtitle("Stay by Age")

stay_side_condition_raw <- stay %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  mutate(side = ifelse(side_lq == "loud", 1, 0)) %>% 
  ggplot() +
  geom_jitter(aes(x = condition, y = side, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = condition, y = side), color = "black", se = FALSE) +
  th +
  theme(legend.position = "top") +
  ggtitle("Stay by Condition")

stay_side_mean_leq_raw <- stay %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  group_by(mean_leq, side_lq) %>% 
  count() %>% 
  mutate(side_lq = factor(side_lq),
        side = ifelse(side_lq == "loud", 1, 0),
        side = factor(side),
         side = fct_relevel(side, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = side_lq), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Chamber Part", 
                    values = c("#d95f02", "#1b9e77"),
                    labels = c("Loud" , "Quiet")) +
  th +
  theme(legend.position = "top")

ggarrange(stay_side_age_raw, stay_side_condition_raw, stay_side_mean_leq_raw, nrow = 2, ncol = 2)
```

```{r days in different parts, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
stay3 <- stay_longer %>% 
  group_by(Site, Origin, side_lq, n) %>% 
  count()  %>% 
  mutate(side_lq = factor(side_lq),
         n = factor(n),
         n = fct_relevel(n, "1", "2", "3", "4"))

stay4 <- data.frame(Site = c("5A", "5A", "5A",
                    "6C", "6C", "6C",
                    "8A", "8A", "8A",
                    "8B", "8B", "8B"),
           Origin = c("Rural", "Rural", "Rural",
                      "Rural", "Rural", "Rural",
                      "Urban", "Urban", "Urban",
                      "Urban", "Urban", "Urban"),
           side_lq = c("loud", "quiet", "tunnel",
                       "loud", "quiet", "tunnel",
                       "loud", "quiet", "tunnel",
                       "loud", "quiet", "tunnel"), 
           n = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
           nn = c(6, 8, 16, 
                  7, 7, 6,
                  3, 3, 9,
                  9, 11, 17))
stay4 <- rbind(stay4, stay3)

stay4 %>% 
  mutate(side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_bar(aes(x = Site, y = nn, fill = n), position="fill", stat="identity", color = "black") +
  xlab("Site") +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Days Spent in \nChamber Part", 
                    values = c("#e6ab02", "grey80", "#666666", "grey20", "#7570b3")) +
  th +
  theme(legend.position = "top") +
  facet_wrap(~side_lq)

stay4 %>% 
  mutate(side_lq = fct_recode(side_lq, "Loud" = "loud", "Quiet" = "quiet", "Tunnel" = "tunnel")) %>% 
ggplot() +
  geom_bar(aes(x = side_lq, y = nn, fill = n), position="fill", stat="identity", color = "black") +
  xlab("Part of the Chamber") +
  ylab("Proportion of Spiders") +
  scale_fill_manual("Days Spent in \nChamber Part", 
                    values = c("#e6ab02", "grey80", "#666666", "grey20", "#7570b3")) +
  th +
  theme(legend.position = "top") +
  facet_wrap(~Site)
```

6C seems more likely to stay in quiet.

### Stats and Assumptions

Let's see what predicts whether a spider that stays chooses loud or quiet. We will use a binomial regression since we can code the data as stayed in the loud (1) or stayed in the quiet (0). We will exclude the two tunnel observations. Since we know age and condition are positively correlated, we will avoid using interactions between age and condition and we will double check the VIF of the final model after backward selection. Let's try with age and conditions as quadratic. We will scale and center all continuous variables. 

```{r stay side stats and assumptions for leq, echo = FALSE, message = FALSE, warning = FALSE}
# of those that stayed, what side did they choose
stay_scaled2 <- stay %>% 
  filter(stay ==1,
         ! side_lq == "tunnel")  %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0)) %>% 
  ungroup() %>% 
  mutate(Dim.1 = c(scale(Dim.1)),
         mean_leq = c(scale(mean_leq)),
         Age = c(scale(Age)),
         condition = c(scale(condition)))

#stay.binom2a <- glm(stay_side ~  mean_leq * poly(Age, 2) + mean_leq * poly(condition, 2), data #= stay_scaled2, family = binomial)
#stay.binom2b <- glm(stay_side ~  mean_leq * Age + mean_leq * poly(condition, 2), data = #stay_scaled2, family = binomial)
#stay.binom2c <- glm(stay_side ~  mean_leq * poly(Age, 2) + mean_leq * condition, data = #stay_scaled2, family = binomial)
#stay.binom2d <- glm(stay_side ~  mean_leq * Age + mean_leq * condition, data = stay_scaled2, #family = binomial)
#anova(stay.binom2a, stay.binom2d, test = "Chisq")
#anova(stay.binom2b, stay.binom2d, test = "Chisq")
#anova(stay.binom2c, stay.binom2d, test = "Chisq") # Use simplest

stay.binom2 <- glm(stay_side ~  mean_leq * Age + mean_leq * condition, data = stay_scaled2, family = binomial)
stay.binom2 <- step(stay.binom2)
summary(stay.binom2) #trend condition
with(summary(stay.binom2), 1 - deviance/null.deviance)

test_stay_side <- augment(stay.binom2, data = stay_scaled2)
resid_stay_side <- ggplot(test_stay, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_stay_side$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_stay_side <- ggplot(test_stay_side, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

test_stay_side$.std.resid <- residuals(stay.binom2, type = "deviance")
scale_loc_stay_side <- ggplot(test_stay_side, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_stay_side <- ggplot(test_stay_side, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()

annotate_figure(ggarrange(resid_stay_side, qq_stay_side, scale_loc_stay_side, cook_stay_side,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Stay Side Binomial"))

plot(hatvalues(stay.binom2), type = 'h')

model.data <- augment(stay.binom2) %>% 
  mutate(index = 1:n()) 
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers
```

```{r stay side stats and assumptions for sites, include = FALSE, message = FALSE, warning = FALSE}
stay_8B_scaled2 <- stay_8B %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  ungroup() %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
stay.binom.8b2 <- glm(stay_side ~ Age + condition, data = stay_8B_scaled2, family = binomial)
stay.binom.8b2 <- step(stay.binom.8b2)
Anova(stay.binom.8b2, test.statistic = "Wald") # condition not sig


stay_8A_scaled2 <- stay_8A %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  ungroup() %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
stay.binom.8a2 <- glm(stay_side ~ Age + condition, data = stay_8A_scaled2, family = binomial)
stay.binom.8a2 <- step(stay.binom.8a2)
Anova(stay.binom.8a2, test.statistic = "Wald") # condition not sig

stay_6C_scaled2 <- stay_6C %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  ungroup() %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
stay.binom.6c2 <- glm(stay_side ~ Age + condition, data = stay_6C_scaled2, family = binomial)
stay.binom.6c2 <- step(stay.binom.6c2)
Anova(stay.binom.6c2, test.statistic = "Wald") # none

stay_5A_scaled2 <- stay_5A %>% 
  filter(stay == 1,
         ! side_lq == "tunnel") %>% 
  ungroup() %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
stay.binom.5a2 <- glm(stay_side ~ Age + condition, data = stay_5A_scaled2, family = binomial)
stay.binom.5a2 <- step(stay.binom.5a2)
Anova(stay.binom.5a2, test.statistic = "Wald") # age not signif
```

Condition stays in the model but does not show a significant difference. Condition stays in the within site models for sites 8A and 8B, but is not significant. Age stays for site 5A, but is not significant.

### Graph 

```{r stay side graph, eval = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
# predictions
pred2 <- expand.grid(condition = seq(-2.5, 2, 0.04))
pred2 <- add_column(pred2, fit = data.frame(predict(stay.binom2, newdata = pred2, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(stay.binom2, newdata = pred2, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred2$condition = pred2$condition * sd(stay$condition) + mean(stay$condition)

stay2 <- stay %>% 
  filter(stay ==1,
         ! side_lq == "tunnel")  %>% 
  mutate(stay_side = ifelse(side_lq == "loud", 1, 0))

ggplot() +
  geom_ribbon(aes(x = condition, y = fit, ymin = fit - (1 * se), ymax = fit + (1 * se)), data = pred2, alpha = 0.65) +
  geom_jitter(aes(x = condition, y = stay_side), data = stay2, height = 0.05, alpha = 1, size = 1) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line(aes(x = condition, y = fit), data = pred2, linewidth = 1) +
  scale_x_continuous(limits = c(-0.35, 0.35), breaks = c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3)) +
  xlab("Body Condition (Residuals of Body Mass and Cephalothorax Width)") +
  ylab("Proportion of Spiders that \nStayed on the Loud Side") +
  th
```

Trend that spiders in poorer condition are most likely to stay on the loud side with increasing likelihood of staying in the quiet with better condition. 

## Spiders in the Tunnel 

**tl;dr:** We used a repeated measures binomial regression to determine predictors of spiders being observed in the tunnel. Age had a polynomial relationship with the probability of being found in the tunnel where younger and older spiders were more likely to be found in the tunnel. 

What we are really interested in, is whether spiders are more frequently found in particular chamber parts. However, three chamber parts complicates a binomial model. Let's figure out if there were any trends involving the tunnel so that we can then focus on loud versus quiet.

Let's first explore each daily observation as the spider being in the tunnel (1) or not (0). 

```{r tunnel exploration, include = FALSE, message = FALSE, warning = FALSE}
# tunnel yes or no
tunnel <- choice_spider %>% 
  mutate(tunnel = ifelse(side_lq == "tunnel", 1, 0))

tunnel_scaled <- tunnel %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)),
         day = c(scale(day)))

mean_leq_raw <- tunnel %>% 
  group_by(mean_leq, tunnel) %>% 
  count() %>% 
  mutate(tunnel = factor(tunnel),
         tunnel = fct_relevel(tunnel, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = tunnel), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("grey", "#7570b3"),
                    labels = c("Moved", "Stayed")) +
  th +
  theme(legend.position = "top")

Age_raw <- tunnel %>% 
  ggplot() +
  geom_point(aes(x = Age, y = tunnel, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = tunnel), color = "black") +
  theme(legend.position = "top")

tunnel %>% 
  ggplot() +
  geom_jitter(aes(x = Age, y = tunnel, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = Age, y = tunnel, color = factor(mean_leq)), se = FALSE) +
  theme(legend.position = "top")

condition_raw <- tunnel %>% 
  ggplot() +
  geom_point(aes(x = condition, y = tunnel, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = tunnel), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

Let's find the best model. 

```{r tunnel stats and assumptions, eval = FALSE, message = FALSE, warning = FALSE}
# global model
tunnel.mod <- buildmer(tunnel ~ mean_leq * day * poly(Age, degree = 2) + mean_leq * condition * day + (1|ID), data = tunnel_scaled, family = binomial)

# Method 1: AIC model selection first
# poly's for all
tunnel.mod <- glmer(tunnel ~ poly(mean_leq, 2) * day * poly(Age, degree = 2) + poly(mean_leq, 2) * poly(condition, degree = 2) * day + (1|ID), data = tunnel_scaled, family = binomial) #194
# polys for none
tunnel.mod2 <- glmer(tunnel ~ mean_leq * day * Age + mean_leq * condition * day + (1|ID), data = tunnel_scaled, family = binomial) #177
anova(tunnel.mod, tunnel.mod2) # use simpler
# only age poly
tunnel.mod3 <- glmer(tunnel ~ mean_leq * day * poly(Age, degree = 2) + mean_leq * condition * day + (1|ID), data = tunnel_scaled, family = binomial) #174
anova(tunnel.mod2, tunnel.mod3) # use simpler, better than 2
#age and leq poly
tunnel.mod4 <- glmer(tunnel ~ poly(mean_leq, 2) * day * poly(Age, degree = 2) + poly(mean_leq, 2) * condition * day + (1|ID), data = tunnel_scaled, family = binomial) #184
anova(tunnel.mod3, tunnel.mod4) # use simpler (3)
# age and condition
tunnel.mod5 <- glmer(tunnel ~ mean_leq * day * poly(Age, degree = 2) + mean_leq * poly(condition, 2) * day + (1|ID), data = tunnel_scaled, family = binomial) # 181
anova(tunnel.mod2, tunnel.mod5) # use simpler (3)
# only condition poly
tunnel.mod6 <- glmer(tunnel ~ mean_leq * day * Age + mean_leq * poly(condition, degree = 2) * day + (1|ID), data = tunnel_scaled, family = binomial) #182
anova(tunnel.mod2, tunnel.mod6)

# Now backward selection
tunnel.mod <- glmer(tunnel ~ mean_leq * day * poly(Age, degree = 2) + mean_leq * condition * day + (1|ID), data = tunnel_scaled, family = binomial) #174
drop1(tunnel.mod, test = "Chisq")
tunnel.mod2 <- update(tunnel.mod, .~. -mean_leq:day:condition)
drop1(tunnel.mod2, test = "Chisq")
tunnel.mod3 <- update(tunnel.mod2, .~. -mean_leq:condition)
drop1(tunnel.mod3, test = "Chisq")
tunnel.mod4 <- update(tunnel.mod3, .~. -day:condition)
drop1(tunnel.mod4, test = "Chisq")
tunnel.mod5 <- update(tunnel.mod4, .~. -condition)
drop1(tunnel.mod5, test = "Chisq")
tunnel.mod6 <- update(tunnel.mod5, .~. -mean_leq:day:poly(Age, degree = 2))
drop1(tunnel.mod6, test = "Chisq")
tunnel.mod7 <- update(tunnel.mod6, .~. -mean_leq:day)
drop1(tunnel.mod7, test = "Chisq")
tunnel.mod8 <- update(tunnel.mod7, .~. -day:poly(Age, degree = 2))
drop1(tunnel.mod8, test = "Chisq")
tunnel.mod9 <- update(tunnel.mod8, .~. -day)
drop1(tunnel.mod9, test = "Chisq")
summary(tunnel.mod9)
tunnel.mod10 <- glmer(tunnel ~ mean_leq * poly(Age, degree = 2) + (mean_leq:poly(Age, degree = 2)|ID), data = tunnel_scaled, family = binomial) 
anova(tunnel.mod9, tunnel.mod10) # use simpler

# Method 2: AIC after
tunnel.mod <- glmer(tunnel ~ poly(mean_leq,2) * day * poly(Age, degree = 2) + poly(mean_leq, 2) * poly(condition,2) * day + (1|ID), data = tunnel_scaled, family = binomial) #174
drop1(tunnel.mod, test = "Chisq")
tunnel.mod2 <- update(tunnel.mod, .~. -poly(mean_leq, 2):day:poly(condition, 2))
drop1(tunnel.mod2, test = "Chisq")
tunnel.mod3 <- update(tunnel.mod2, .~. -poly(mean_leq, 2):poly(condition, 2))
drop1(tunnel.mod3, test = "Chisq")
tunnel.mod4 <- update(tunnel.mod3, .~. -poly(mean_leq, 2):day:poly(Age, degree = 2))
drop1(tunnel.mod4, test = "Chisq")
tunnel.mod5 <- update(tunnel.mod4, .~. -day:poly(condition, 2))
drop1(tunnel.mod5, test = "Chisq")
tunnel.mod6 <- update(tunnel.mod5, .~. -poly(condition, 2))
drop1(tunnel.mod6, test = "Chisq")
tunnel.mod7 <- update(tunnel.mod6, .~. -poly(mean_leq, 2):day)
drop1(tunnel.mod7, test = "Chisq")
tunnel.mod8 <- update(tunnel.mod7, .~. -day:poly(Age, degree = 2))
drop1(tunnel.mod8, test = "Chisq")
tunnel.mod9 <- update(tunnel.mod8, .~. -day)
drop1(tunnel.mod9, test = "Chisq")
summary(tunnel.mod9)

# all poly
tunnel.mod <- glmer(tunnel ~ poly(mean_leq, 2) * poly(Age, degree = 2) + (1|ID), data = tunnel_scaled, family = binomial)
summary(tunnel.mod)
MuMIn::r.squaredGLMM(tunnel.mod)
# no poly
tunnel.mod2 <- glmer(tunnel ~ mean_leq * Age + (1|ID), data = tunnel_scaled, family = binomial)
anova(tunnel.mod, tunnel.mod2) # with poly better
# age ploy only
tunnel.mod3 <- glmer(tunnel ~ mean_leq * poly(Age, 2) + (1|ID), data = tunnel_scaled, family = binomial) 
anova(tunnel.mod2, tunnel.mod3) # this one best
summary(tunnel.mod3)
MuMIn::r.squaredGLMM(tunnel.mod3)
# leq poly only
tunnel.mod4 <- glmer(tunnel ~ poly(mean_leq, 2) * Age + (1|ID), data = tunnel_scaled, family = binomial)
anova(tunnel.mod, tunnel.mod4) # polies better
# best with slope and intercept varying by ID
tunnel.mod5 <- glmer(tunnel ~ mean_leq * poly(Age, 2) + (mean_leq:poly(Age, 2)|ID), data = tunnel_scaled, family = binomial)
anova(tunnel.mod3, tunnel.mod5) # better but not significantly

plot(resid(tunnel.mod3, type = "pearson") ~ hat(model.matrix(tunnel.mod3)), las = 1, ylab = "Standardised residuals", xlab = "Leverage")

model.data <- augment(tunnel.mod3) %>% 
  mutate(index = 1:n()) 
model.data$.std.resid <- residuals(tunnel.mod3, type = "deviance")
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers

vif(tunnel.mod3)
#no multicolinearity

# AIC MODEL SELECTION SHOWS SAME RESULTS BEFORE AND AFTER BACKWARD SELECTION
```

The best model includes the interaction between leq and age as a polynomial and ID as a random effect. 

glmer(tunnel ~ mean_leq * poly(Age, 2) + (1|ID), data = tunnel_scaled, family = binomial) 

Let's graph the results. 

```{r tunnel graph, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
tunnel.mod <- glmer(tunnel ~ mean_leq * poly(Age, 2) + (1|ID), data = tunnel_scaled, family = binomial) 
MuMIn::r.squaredGLMM(tunnel.mod)

pred <- expand.grid(mean_leq = quantile(tunnel_scaled$mean_leq, probs = c(0, 0.5, 1)),
                  Age = seq(-2.5, 2.5, 0.05))
pred$fit <- predict(tunnel.mod, newdata = pred, se.fit = TRUE, re.form = NA, type = "response")

myFunc <- function(mm) {
    predict(mm, newdata = pred, re.form = ~0, type = "response")
}
#bigBoot_tunnel <- bootMer(tunnel.mod, myFunc, nsim = 1000)
#saveRDS(bigBoot_tunnel, file = "data/bigBoot_tunnel.Rds")
bigBoot_tunnel <- readRDS("data/bigBoot_tunnel.Rds")
predSE <- t(apply(bigBoot_tunnel$t, MARGIN = 2, FUN = sd, na.rm = TRUE))
pred$se <- predSE[1, ]

# back transform
pred$mean_leq = pred$mean_leq * sd(tunnel$mean_leq) + mean(tunnel$mean_leq)
pred$Age = pred$Age * sd(tunnel$Age) + mean(tunnel$Age)

tunnel2 <- tunnel %>% 
  group_by(Age, mean_leq, tunnel) %>% 
  count()

tunnel3 <- ggplot() +
    geom_ribbon(aes(x = Age, y = fit, ymin = fit - (1 * se), ymax = fit + (1 * se), group = factor(mean_leq), color = factor(mean_leq), fill = factor(mean_leq)), data = pred, alpha = 0.5) +
  geom_line(aes(x = Age, y = fit, group = factor(mean_leq), color = factor(mean_leq)), data = pred) +
    geom_jitter(aes(x = Age, y = tunnel, color = factor(mean_leq), size = n), data = tunnel2, height = 0.1, alpha = 0.6) +
  xlab("Age (Days Since Mature)") +
  ylab("Proportion of Spiders Observed \nin the Tunnel") +
  scale_fill_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  scale_size_continuous("Number of \nObservations") +
  th +
  theme(legend.position = "top", legend.box = "vertical")

jpeg("figures/tunnel.jpeg", width = 3.5, height = 3.5, units = "in", quality = 100, res = 300)
print(tunnel3)
dev.off()
tunnel3
```

Now let's look at whether each spider was ever found in the tunnel. 

```{r tunnel ever exploration, echo = FALSE, message = FALSE, warning = FALSE}
# ever found in the tunnel
tunnel_ever <- choice_spider %>% 
  mutate(tunnel = ifelse(side_lq == "tunnel", 1, 0)) %>% 
  group_by(ID, Age, condition, Site, mean_leq) %>% 
  summarize(days_tunnel = sum(tunnel)) %>% 
  mutate(tunnel_any = ifelse(days_tunnel > 0, 1, 0))
tunnel_ever_scaled <- tunnel_ever %>% 
  ungroup() %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)),
         mean_leq = c(scale(mean_leq)))

mean_leq_raw <- tunnel_ever %>% 
  group_by(mean_leq, tunnel_any) %>% 
  count() %>% 
  mutate(tunnel_any = factor(tunnel_any),
         tunnel_any = fct_relevel(tunnel_any, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = tunnel_any), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("grey", "#7570b3"),
                    labels = c("Moved", "Stayed")) +
  th +
  theme(legend.position = "top")

Age_raw <- tunnel_ever %>% 
  ggplot() +
  geom_point(aes(x = Age, y = tunnel_any, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = tunnel_any), color = "black") +
  theme(legend.position = "top")

tunnel_ever %>% 
  ggplot() +
  geom_jitter(aes(x = Age, y = tunnel_any, color = factor(mean_leq)), height = 0.05) +
  geom_smooth(aes(x = Age, y = tunnel_any, color = factor(mean_leq)), se = FALSE) +
  theme(legend.position = "top")

condition_raw <- tunnel_ever %>% 
  ggplot() +
  geom_point(aes(x = condition, y = tunnel_any, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = tunnel_any), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

Find the best model.

```{r tunnel ever stats and assumptions, eval = FALSE, message = FALSE, warning = FALSE}
# Method 1: AIC model selection before
# all poly
tunnel.mod <- glm(tunnel_any ~ poly(mean_leq, 2) * poly(Age, 2) + poly(mean_leq, 2) * poly(condition, 2), data = tunnel_ever_scaled, family = binomial) # 87.76
#no poly
tunnel.mod2 <- glm(tunnel_any ~ mean_leq * Age + mean_leq * condition, data = tunnel_ever_scaled, family = binomial) #86.11
anova(tunnel.mod, tunnel.mod2, test = "Chisq") # more complex nearly better
#only age
tunnel.mod3 <- glm(tunnel_any ~ mean_leq * poly(Age, 2) + mean_leq * condition, data = tunnel_ever_scaled, family = binomial) # 85
anova(tunnel.mod, tunnel.mod3, test = "Chisq") #better than all poly, nearly better than no poly
#only leq
tunnel.mod4 <- glm(tunnel_any ~ poly(mean_leq, 2) * Age + poly(mean_leq, 2) * condition, data = tunnel_ever_scaled, family = binomial) # 81.57
anova(tunnel.mod2, tunnel.mod4, test = "Chisq") #better than all poly and no poly
#only condition
tunnel.mod5 <- glm(tunnel_any ~ mean_leq * Age + mean_leq * poly(condition, 2), data = tunnel_ever_scaled, family = binomial) # 89.23
anova(tunnel.mod2, tunnel.mod5, test = "Chisq") #all poly and no poly better
#leq and age
tunnel.mod6 <- glm(tunnel_any ~ poly(mean_leq, 2) * poly(Age, 2) + poly(mean_leq, 2) * condition, data = tunnel_ever_scaled, family = binomial) # 82.99
anova(tunnel.mod4, tunnel.mod6, test = "Chisq") # better than all and no poly, only leq better
# age and condition
tunnel.mod7 <- glm(tunnel_any ~ mean_leq * poly(Age, 2) + mean_leq * poly(condition, 2), data = tunnel_ever_scaled, family = binomial) # 87.52
anova(tunnel.mod, tunnel.mod7, test = "Chisq") # not this one
# leq and condition
tunnel.mod8 <- glm(tunnel_any ~ poly(mean_leq, 2) * Age + poly(mean_leq, 2) * poly(condition, 2), data = tunnel_ever_scaled, family = binomial) # 86.79

tunnel.mod <- glm(tunnel_any ~ poly(mean_leq, 2) * Age + poly(mean_leq, 2) * condition, data = tunnel_ever_scaled, family = binomial)
tunnel.mod <- step(tunnel.mod) # leq x age
summary(tunnel.mod) 


# Method 2: AIC selection after
tunnel.mod <- glm(tunnel_any ~ poly(mean_leq, 2) * poly(Age, 2) + poly(mean_leq, 2) * poly(condition, 2), data = tunnel_ever_scaled, family = binomial) # 87.76
tunnel.mod <- step(tunnel.mod) # leq * age
tunnel.mod <- glm(tunnel_any ~ poly(mean_leq, 2) * poly(Age, 2), data = tunnel_ever_scaled, family = binomial) # 77.38
summary(tunnel.mod)

# no poly
tunnel.mod2 <- glm(tunnel_any ~ mean_leq * Age, data = tunnel_ever_scaled, family = binomial)
summary(tunnel.mod2) # 82.6
anova(tunnel.mod, tunnel.mod2, test = "Chisq") # all poly better

# only age poly
tunnel.mod3 <- glm(tunnel_any ~ mean_leq * poly(Age, 2), data = tunnel_ever_scaled, family = binomial)
summary(tunnel.mod3) # 81.09
anova(tunnel.mod, tunnel.mod3, test = "Chisq") # better than no poly, but not all poly

# only leq poly
tunnel.mod4 <- glm(tunnel_any ~ poly(mean_leq, 2) * Age, data = tunnel_ever_scaled, family = binomial)
summary(tunnel.mod4) # 76.51
anova(tunnel.mod2, tunnel.mod4, test = "Chisq") # better than all poly and no poly

with(summary(tunnel.mod4), 1 - deviance/null.deviance)

plot(hatvalues(tunnel.mod), type = 'h')

model.data <- augment(tunnel.mod) %>% 
  mutate(index = 1:n()) 
model.data$.std.resid <- residuals(tunnel.mod, type = "deviance")
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers

vif(tunnel.mod)
#wild multicolinearity

# remove interaction
tunnel.mod <- glm(tunnel_any ~ poly(mean_leq, 2) + poly(Age, 2), data = tunnel_ever_scaled, family = binomial) # 79.42
tunnel.mod2 <- glm(tunnel_any ~ mean_leq + poly(Age, 2), data = tunnel_ever_scaled, family = binomial) #79.98
anova(tunnel.mod, tunnel.mod2, test = "Chisq") # simpler - only age poly
tunnel.mod3 <- glm(tunnel_any ~ poly(mean_leq, 2) + Age, data = tunnel_ever_scaled, family = binomial) # 83.22
summary(tunnel.mod2)

vif(tunnel.mod2)
```

```{r tunnel ever graph, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
tunnel.mod2 <- glm(tunnel_any ~ mean_leq + poly(Age, 2), data = tunnel_ever_scaled, family = binomial) #79.98

# did the spider ever go in the tunnel
pred <- expand.grid(mean_leq = quantile(tunnel_ever_scaled$mean_leq, probs = c(0, 0.5, 1)),
                  Age = seq(-2.5, 2.5, 0.05))
pred <- add_column(pred, fit = data.frame(predict(tunnel.mod2, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(tunnel.mod2, newdata = pred, type = "response", se.fit = TRUE))$se.fit )

# back transform
pred$mean_leq = pred$mean_leq * sd(tunnel_ever$mean_leq) + mean(tunnel_ever$mean_leq)
pred$Age = pred$Age * sd(tunnel_ever$Age) + mean(tunnel_ever$Age)

tunnel_ever2 <- ggplot() +
  geom_line(aes(x = Age, y = fit, group = factor(mean_leq), color = factor(mean_leq)), data = pred, linewidth = 1) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (1 * se), ymax = fit + (1 * se), group = factor(mean_leq), color = factor(mean_leq), fill = factor(mean_leq)), data = pred, alpha = 0.5) +
  geom_jitter(aes(x = Age, y = tunnel_any, group = factor(mean_leq), color = factor(mean_leq)), data = tunnel_ever, width = 1.5, height = 0.05, alpha = 1, size = 1) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  xlab("Age (Days Since Mature)") +
  ylab("Proportion of Spiders that \nwere Found in the Tunnel") +
  scale_fill_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  th +
  theme(legend.position = "top")

jpeg("figures/tunnel_ever.jpeg", width = 3.5, height = 2.5, units = "in", quality = 100, res = 300)
print(tunnel_ever2)
dev.off()
tunnel_ever2
```

```{r tunnel ever stats and assumptions for sites, echo = FALSE, message = FALSE, warning = FALSE}
tunnel_8B <- tunnel_ever %>% 
  filter(Site == "8B")

tunnel.mod.8b <- glm(tunnel_any ~ poly(Age, 2), data = tunnel_8B, family = binomial)
summary(tunnel.mod.8b) # no diff

tunnel_8A <- tunnel_ever %>% 
  filter(Site == "8A")

tunnel.mod.8a <- glm(tunnel_any ~ poly(Age, 2), data = tunnel_8A, family = binomial)
summary(tunnel.mod.8a) # not enough data

tunnel_6C <- tunnel_ever %>% 
  filter(Site == "6C")

tunnel.mod.6c <- glm(tunnel_any ~ poly(Age, 2), data = tunnel_6C, family = binomial)
summary(tunnel.mod.6c) # no diff

tunnel_5A <- tunnel_ever %>% 
  filter(Site == "5A")

tunnel.mod.5a <- glm(tunnel_any ~ poly(Age, 2), data = tunnel_5A, family = binomial)
summary(tunnel.mod.5a) # no diff
```

## Spiders in Loud or Quiet

**tl;dr:** We used a repeated measures binomial regression to determine what predicts a spider being found on the loud or quiet side. There is a trend of an interaction between site leq and age. Spiders from the loudest site are likely to be on the loud side at young ages and then become increasingly likely to be on the quiet side. Quieter sites don't seem to show a choice regardless of age. 

We want to remove any observations including spiders in the tunnel and determine what predicts the spider being found on the loud or quiet side of the chamber. 

```{r loud quiet exploration, echo = FALSE, message = FALSE, warning = FALSE}
choice_lq <- choice_spider %>% 
  filter(! side_lq == "tunnel") %>% 
  mutate(side = ifelse(side_lq == "loud", 1, 0))

choice_lq_scaled <- choice_lq %>% 
  mutate(mean_leq = c(scale(mean_leq)),
         Age = c(scale(Age)),
         condition = c(scale(condition))
  )

mean_leq_raw <- choice_lq %>% 
  group_by(mean_leq, side) %>% 
  count() %>% 
  mutate(side = factor(side),
         side = fct_relevel(side, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = side), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("#d95f02", "#1b9e77"),
                    labels = c("Loud", "Quiet")) +
  th +
  theme(legend.position = "top")

Age_raw <- choice_lq %>% 
  ggplot() +
  geom_point(aes(x = Age, y = side, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = side), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice_lq %>% 
  ggplot() +
  geom_point(aes(x = condition, y = side, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = side), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

Find the best model.

```{r loud quiet stats and assumptions, eval = FALSE, message = FALSE, warning = FALSE}
lq1 <- glmer(side ~ mean_leq * day * Age + mean_leq * day * condition + (1|ID), data = choice_lq_scaled, family = binomial)
drop1(lq1, test = "Chisq")
lq2 <- update(lq1, .~. -mean_leq:day:condition)
drop1(lq2, test = "Chisq")
lq3 <- update(lq2, .~. -day:condition)
drop1(lq3, test = "Chisq")
lq4 <- update(lq3, .~. -mean_leq:day:Age)
drop1(lq4, test = "Chisq")
lq5 <- update(lq4, .~. -mean_leq:day)
drop1(lq5, test = "Chisq")
lq6 <- update(lq5, .~. -day:Age)
drop1(lq6, test = "Chisq")
lq7 <- update(lq6, .~. -mean_leq:condition)
drop1(lq7, test = "Chisq")
lq8 <- update(lq7, .~. -condition)
drop1(lq8, test = "Chisq")
lq9 <- update(lq8, .~. -day)
drop1(lq9, test = "Chisq")
summary(lq9)
MuMIn::r.squaredGLMM(lq9)

lq <- glmer(side ~ mean_leq * Age + (mean_leq:Age|ID), data = choice_lq_scaled, family = binomial)
summary(lq)
anova(lq9, lq, test = "Chisq") # simpler better

plot(resid(lq9, type = "pearson") ~ hat(model.matrix(lq9)), las = 1, ylab = "Standardised residuals", xlab = "Leverage")

model.data <- augment(lq9) %>% 
  mutate(index = 1:n()) 
model.data$.std.resid <- residuals(lq9, type = "deviance")
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers

vif(lq9)
#no multicolinearity
```

The top model includes an interaction between age and leq, although the interaction is not significant. 

Let's graph the results.

```{r loud quiet graph, echo = FALSE, message = FALSE, warning = FALSE}
lq <- glmer(side ~ mean_leq * Age + (1|ID), data = choice_lq_scaled, family = binomial)

pred <- expand.grid(mean_leq = quantile(choice_lq_scaled$mean_leq, probs = c(0, 0.5, 1)),
                  Age = seq(-2, 2.5, 0.05))
pred$fit <- predict(lq, newdata = pred, se.fit = TRUE, re.form = NA, type = "response")

myFunc <- function(mm) {
    predict(mm, newdata = pred, re.form = ~0, type = "response")
}
#bigBoot_spider_side <- bootMer(lq, myFunc, nsim = 1000)
#saveRDS(bigBoot_spider_side, file = "data/bigBoot_spider_side.Rds")
bigBoot_spider_side <- readRDS("data/bigBoot_spider_side.Rds")
predSE <- t(apply(bigBoot_spider_side$t, MARGIN = 2, FUN = sd))
pred$se <- predSE[1, ]

# back transform
pred$Age = pred$Age * sd(choice_lq$Age) + mean(choice_lq$Age)
pred$mean_leq = pred$mean_leq * sd(choice_lq$mean_leq) + mean(choice_lq$mean_leq)

choice_lq2 <- choice_lq %>% 
  group_by(Age, mean_leq, side) %>% 
  count()

spider_side <- ggplot() +
  geom_jitter(aes(x = Age, y = side, color = factor(mean_leq), size = n), data = choice_lq2, height = 0.1, alpha = 0.5) +
  geom_line(aes(x = Age, y = fit, color = factor(mean_leq)), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - se, ymax = fit + se, fill = factor(mean_leq)), data = pred, alpha = 0.5) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  xlab("Age (Days Since Mature)") +
  ylab("Proportion of Spiders that \nwere Found on the Loud Side") +
  scale_y_continuous(limits = c(-0.15, 1.1), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  scale_fill_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"),
                     labels = c("-69", "-64", "-55")) +
  th +
  theme(legend.position = "top", legend.box="vertical")

jpeg("figures/spider_side.jpeg", width = 3.5, height = 3, units = "in", quality = 100, res = 300)
print(spider_side)
dev.off()
spider_side
```

```{r loud quiet stats and assumptions by site, eval = FALSE, message = FALSE, warning = FALSE}
choice_lq_8B <- choice_lq %>% 
  filter(Site == "8B")
lq_8b <- glmer(side ~ Age + (1|ID), data = choice_lq_8B, family = binomial)
summary(lq_8b) # trend

choice_lq_8A <- choice_lq %>% 
  filter(Site == "8A")
lq_8a <- glmer(side ~ Age + (1|ID), data = choice_lq_8A, family = binomial)
summary(lq_8a) # no diff

choice_lq_6C <- choice_lq %>% 
  filter(Site == "6C")
lq_6c <- glmer(side ~ Age + (1|ID), data = choice_lq_6C, family = binomial)
summary(lq_6c) # no diff

choice_lq_5A <- choice_lq %>% 
  filter(Site == "5A")
lq_5a <- glmer(side ~ Age + (1|ID), data = choice_lq_5A, family = binomial)
summary(lq_5a) # no diff
```

There is a trend by age in the loud site. 


## Choice Photos

```{r choice photos, echo = FALSE, message = FALSE, warning = FALSE}
photos <- read.csv("data/choice_photos.csv", header = TRUE)

photos_seen <- photos %>% 
  mutate(prop = night_loud / (night_loud + night_quiet)) %>% 
  pivot_longer(cols = c(night_unseen, night_seen), values_to = "photos", names_to = "seen") %>% 
  mutate(seen = fct_recode(seen, "Yes" = "night_seen", "No" = "night_unseen"),
         seen = fct_relevel(seen, "No", "Yes"))

seen <- ggplot() +
  geom_bar(aes(y = reorder(ID, prop), x = photos, fill = seen), data = photos_seen, position = "fill", stat = "identity") +
  ylab("Spider ID") +
  xlab("Proportion of \nNight Photos") +
  scale_fill_manual("", values = c("grey", "#7570b3"), labels = c("Unseen", "Visible")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  th +
  theme(legend.position = "top") +
  facet_grid(rows = vars(Site), scales = "free", space = 'free', switch = "y")

photos_side <- photos %>% 
  mutate(prop = night_loud / (night_loud + night_quiet)) %>% 
  pivot_longer(cols = c(night_loud, night_quiet), values_to = "photos", names_to = "side") %>% 
  mutate(side = fct_recode(side, "Loud" = "night_loud", "Quiet" = "night_quiet"),
         side = fct_relevel(side, "Quiet", "Loud"))

side <- ggplot() +
  geom_bar(aes(y = reorder(ID, prop), x = photos, fill = side), data = photos_side, position = "fill", stat = "identity") +
  geom_vline(xintercept = 0.5, linetype = "dashed") +
  ylab("Spider ID") +
  xlab("Proportion of Night \nPhotos with Spider Visible") +
  scale_fill_manual("", values = c("#1b9e77", "#d95f02"), labels = c("Quiet", "Loud")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  th +
  theme(legend.position = "top") +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank()) +
  facet_grid(rows = vars(Site), scales = "free", space = 'free', switch = "y")

photos_night <- ggarrange(seen, side, ncol = 2, widths = c(0.55, 0.45))

jpeg("figures/photos_night.jpeg", width = 5, height = 6, units = "in", quality = 100, res = 300)
print(photos_night)
dev.off()
photos_night

activity <- photos %>% 
  pivot_longer(cols = c("X20.30":"X20.00"), values_to = "active", names_to = "hour") %>% 
  mutate(hour = fct_recode(hour, 
                           "20.5" = "X20.30",
                           "21.5" = "X21.30",
                           "22.5" = "X22.30",
                           "23.5" = "X23.30",
                           "0.5" = "X00.30",
                           "1.5" = "X01.30",
                           "2.5" = "X02.30",
                           "3.5" = "X03.30",
                           "4.5" = "X04.30",
                           "5.5" = "X05.30",
                           "6.5" = "X06.30",
                           "7.5" = "X07.30",
                           "8.5" = "X08.30",
                           "9.5" = "X09.30",
                           "10.5" = "X10.30",
                           "11.5" = "X11.30",
                           "12.5" = "X12.30",
                           "13.5" = "X13.30",
                           "14.5" = "X14.30",
                           "15.5" = "X15.30",
                           "16.5" = "X16.30",
                           "17.5" = "X17.30",
                           "18.5" = "X18.30",
                           "19.5" = "X19.30",
                           "21" = "X21.00",
                           "22" = "X22.00",
                           "23" = "X23.00",
                           "0" = "X00.00",
                           "1" = "X01.00",
                           "2" = "X02.00",
                           "3" = "X03.00",
                           "4" = "X04.00",
                           "5" = "X05.00",
                           "6" = "X06.00",
                           "7" = "X07.00",
                           "8" = "X08.00",
                           "9" = "X09.00",
                           "10" = "X10.00",
                           "11" = "X11.00",
                           "12" = "X12.00",
                           "13" = "X13.00",
                           "14" = "X14.00",
                           "15" = "X15.00",
                           "16" = "X16.00",
                           "17" = "X17.00",
                           "18" = "X18.00",
                           "19" = "X19.00",
                           "20" = "X20.00"
                           )) %>% 
  mutate(hour = as.character(hour),
         hour = as.numeric(hour)) %>% 
  group_by(hour, Origin) %>% 
  summarize(mean = mean(active, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "Origin", values_from = "mean")

ggplot() +
  geom_line(aes(x = hour, y = Loud, group = 1), color = "#d95f02", data = activity) +
  geom_line(aes(x = hour, y = Quiet, group = 1), color = "#1b9e77", data = activity) +
  geom_area(aes(x = hour, y = Loud, group = 1), fill = "#d95f02", data = activity, alpha = 0.5) +
  geom_area(aes(x = hour, y = Quiet, group = 1), fill = "#1b9e77", data = activity, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 24), breaks = seq(0, 24, 2)) +
  th


activity_hours <- photos %>% 
  mutate(X21 = X21.00 + X21.30,
         X22 = X22.00 + X22.30,
         X23 = X23.00 + X23.30,
         X00 = X00.00 + X00.30,
         X01 = X01.00 + X01.30,
         X02 = X02.00 + X02.30,
         X03 = X03.00 + X03.30,
         X04 = X04.00 + X04.30,
         X05 = X05.00 + X05.30,
         X06 = X06.00 + X06.30,
         X07 = X07.00 + X07.30,
         X08 = X08.00 + X08.30,
         X09 = X09.00 + X09.30,
         X10 = X10.00 + X10.30,
         X11 = X11.00 + X11.30,
         X12 = X12.00 + X12.30,
         X13 = X13.00 + X13.30,
         X14 = X14.00 + X14.30,
         X15 = X15.00 + X15.30,
         X16 = X16.00 + X16.30,
         X17 = X17.00 + X17.30,
         X18 = X18.00 + X18.30,
         X19 = X19.00 + X19.30,
         X20 = X20.00 + X20.30) %>% 
  pivot_longer(cols = c("X20":"X21"), values_to = "active", names_to = "hour") %>% 
  mutate(hour = fct_recode(hour, 
                           "20" = "X20",
                           "21" = "X21",
                           "22" = "X22",
                           "23" = "X23",
                           "0" = "X00",
                           "1" = "X01",
                           "2" = "X02",
                           "3" = "X03",
                           "4" = "X04",
                           "5" = "X05",
                           "6" = "X06",
                           "7" = "X07",
                           "8" = "X08",
                           "9" = "X09",
                           "10" = "X10",
                           "11" = "X11",
                           "12" = "X12",
                           "13" = "X13",
                           "14" = "X14",
                           "15" = "X15",
                           "16" = "X16",
                           "17" = "X17",
                           "18" = "X18",
                           "19" = "X19",
                           "20" = "X20"
                           )) %>% 
  mutate(hour = as.character(hour),
         hour = as.numeric(hour)) %>% 
  group_by(hour, Origin) %>% 
  summarize(mean = mean(active, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "Origin", values_from = "mean")

colors <- c("Urban" = "#d95f02", "Rural" = "#1b9e77")

activity_graph <- ggplot() +
  geom_rect(aes(xmin = 0, xmax = 8, ymin = 0, ymax = 11), fill = "grey") +
  geom_rect(aes(xmin = 20, xmax = 23, ymin = 0, ymax = 11), fill = "grey") +
  geom_line(aes(x = hour, y = Loud, group = 1), color = "#d95f02", data = activity_hours) +
  geom_line(aes(x = hour, y = Quiet, group = 1), color = "#1b9e77", data = activity_hours) +
  geom_area(aes(x = hour, y = Loud, group = 1, fill = "Urban"), data = activity_hours, alpha = 0.5) +
  geom_area(aes(x = hour, y = Quiet, group = 1, fill = "Rural"), data = activity_hours, alpha = 0.5) +
  xlab("Hour of the Day") +
  ylab("Average Number of Photos \nwith Position Change") +
  scale_x_continuous(limits = c(0, 23), breaks = seq(0, 23, 2), expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 11), breaks = seq(0, 10, 2), expand = c(0,0)) +
  scale_fill_manual("Origin", values = c("Urban" = "#d95f02", "Rural" = "#1b9e77")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  th +
  theme(legend.position = "top")

jpeg("figures/activity_graph.jpeg", width = 5, height = 3, units = "in", quality = 100, res = 300)
print(activity_graph)
dev.off()
activity_graph
```


# Silk Side

## Side with More Silk

**tl;dr:** We used a binomial regression to determine the probability of spiders building webs on the loud (1) or quiet (0) side. We scaled and centered mean_leq, condition and age, but back transformed for graphs. We got similar results with age and condition as polynomials or linear, so we used the linear. Body condition was removed during backward selection. The likelihood of choosing one side over another did not vary by site Leq or age. However, an interaction between Leq and age suggests a trend that the young spiders showed increasing choice for loud with origin Leq but older spiders did not exhibit a choice. Only the loudest site (8B) spiders had a majority choose a particular side (significant difference from 50%).

The first thing we want to do is assess the number of spiders that "chose" (put more silk) on the loud side over the quiet side, and compare it across sites. We can analyze this question in a number of ways. Let's see a quick breakdown of the data.

```{r summary of side choice, echo = FALSE, warning = FALSE, message = FALSE}
choice %>% 
  # group by all the different ways we can use site
  group_by(Site, mean_leq, Origin) %>% 
  # count the number of loud and quiet choices
  count(side_w_more) %>% 
  pivot_wider(names_from = "side_w_more", values_from = "n") %>% 
  # calculate the proportion of spiders that chose loud
  mutate(prop = round(loud / (loud + quiet), 2))
```

Site can be used as **categorical** or **ordinal** or replaced by **Leq** or **origin** (rural vs urban). We've decided to refrain from using site as a categorical variable because there is some logical ordering of the sites (by leq). However, two sites have the same average Leq (6C and 5A) and there is not a reason that we would put one in front of the other. Thus, we think using the **Leq is the best metric**. We still want to see what **individual sites** are doing so we can look at each site individually. We will also test **origin**. 

Choice can be also be assessed in a number of ways:

- **binary** data with a binomial distribution (logistic regression) - preferred

- **proportional** data with a beta distribution (not good with only four sites)

- **count** data with a poisson distribution (not good; we have an upper bound)

We will make choice **binary** with 1's entered for loud choice and 0 entered for quiet choice. We can include age (days since maturation) and body condition (residuals of lm of log mass and log cephalothorax width). We will scale and center all of the predictor variables first.

Let's look at the shape of the raw data.

```{r silk loud quiet exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice %>% 
  group_by(mean_leq, side) %>% 
  count() %>% 
  mutate(side = factor(side),
         side = fct_relevel(side, "0", "1")) %>% 
ggplot() +
  geom_bar(aes(x = mean_leq, y = n, fill = side), position="fill", stat="identity") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  ylab("Proportion of Spiders") +
  scale_fill_manual("", 
                    values = c("#d95f02", "#1b9e77"),
                    labels = c("Loud", "Quiet")) +
  th +
  theme(legend.position = "top")

Age_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = Age, y = side, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = side), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = condition, y = side, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = side), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

We may need to use polynomials for age and condition.

Let's find the best fit model. 

```{r binomial stats, echo = FALSE, warning = FALSE, message = FALSE}
binom_leq <- glm(side ~ mean_leq * Age + mean_leq * condition, 
                 data = choice_scaled, family = binomial(link = "logit"))
binom_leq2 <- glm(side ~ mean_leq * poly(Age, 2) + mean_leq * poly(condition, 2), 
                 data = choice_scaled, family = binomial(link = "logit"))
anova(binom_leq, binom_leq2, test = "Chisq") # both polys better
binom_leq3 <- glm(side ~ mean_leq * poly(Age, 2) + mean_leq * condition, 
                 data = choice_scaled, family = binomial(link = "logit"))
anova(binom_leq2, binom_leq3, test = "Chisq") # both polys better
binom_leq4 <- glm(side ~ mean_leq * Age + mean_leq * poly(condition, 2), 
                 data = choice_scaled, family = binomial(link = "logit"))
anova(binom_leq2, binom_leq4, test = "Chisq") # both polys better


binom_leq <- glm(side ~ mean_leq * poly(Age, 2) + mean_leq * poly(condition, 2), 
                 data = choice_scaled, family = binomial(link = "logit"))
binom_leq <- step(binom_leq)
summary(binom_leq)
with(summary(binom_leq), 1 - deviance/null.deviance)
#simulateResiduals(binom_leq, plot = TRUE) # dispersion test

plot(hatvalues(binom_leq), type = 'h')

model.data <- augment(binom_leq) %>% 
  mutate(index = 1:n()) 
model.data %>% 
  filter(abs(.std.resid) > 3)
#no outliers

vif(binom_leq)
# not terrible

# similar results without polynomials
binom_leq <- glm(side ~ mean_leq * Age + mean_leq * condition, 
                 data = choice_scaled, family = binomial(link = "logit"))
binom_leq <- step(binom_leq)
summary(binom_leq)
with(summary(binom_leq), 1 - deviance/null.deviance)
vif(binom_leq)
```

We get similar results with and without age and condition as polynomials. The only significant relationship is a linear interaction between age and leq. 

Let's graph it. 

```{r binomial leq graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
# leq age interaction
stacked <- choice %>% 
  # let's use above and below the median age, labeling them as 15 and 32 just makes faceting easier later
  mutate(Age = ifelse(Age < median(Age), 15, 32)) %>% 
  group_by(mean_leq, Age) %>% 
  count(side_w_more) %>% 
  mutate(side_w_more = fct_relevel(side_w_more, "quiet", "loud")) 

labs <- c("Bars: Proportion < Median Age \nLine: Predictions at 1st Quartile Age",
          "Bars: Proportion >= Median Age \nLine: Predictions at 3rd Quartile Age")
names(labs) <- c("15", "32")

nd = expand.grid(mean_leq = seq(-1, 1.4, 0.02),
                Age = quantile(choice_scaled$Age, probs = c(0.25, 0.75)))
nd <- add_column(nd, fit = predict(binom_leq, newdata = nd, type = "response"),
                 se = predict(binom_leq, newdata = nd, se.fit = TRUE, type = "response")$se.fit)
# back transform
nd$mean_leq = nd$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq)
nd$Age = nd$Age * sd(choice$Age) + mean(choice$Age)

num_leq <- ggplot() +
  geom_bar(aes(fill=side_w_more, y=n, x=mean_leq), position="fill", stat="identity", data = stacked, alpha = 0.75) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line(aes(x = mean_leq, y = fit, group = factor(Age)), data = nd) +
  geom_ribbon(aes(x = mean_leq, ymin = fit - se, ymax = fit + se, group = factor(Age)), data = nd, alpha = 0.5) +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  scale_fill_manual("Side with \nMore Silk", 
                    values = c("#1B9E77", "#D95F02"),
                    labels = c("Quiet", "Loud")) +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  ylab("Proportion of Spiders") +
  th +
  facet_wrap(~Age, labeller = labeller(Age = labs))

jpeg("figures/num_leq.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(num_leq)
dev.off()
num_leq

# another way to view
nd = expand.grid(mean_leq = quantile(choice_scaled$mean_leq, probs = c(0, 0.5, 1)),
                Age = seq(-2.5, 2.5, 0.2))
nd <- add_column(nd, fit = predict(binom_leq, newdata = nd, type = "response"),
                 se = predict(binom_leq, newdata = nd, type = "response", se.fit = TRUE)$se.fit)
# back transform
nd$Age = nd$Age * sd(choice$Age) + mean(choice$Age)
nd$mean_leq = round(nd$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq), 0)

nd %>% 
ggplot(aes(x = Age, y = fit, group = factor(mean_leq), color = factor(mean_leq), fill = factor(mean_leq))) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line() +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se), alpha = 0.5) +
  ylab("Proportion of Spiders") +
  xlab("Age (days since maturation)") +
  scale_y_continuous(limits = c(-0.05, 1.05), breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  scale_fill_manual("Site Average Leq", 
                    values = c("#1B9E77", "grey20", "#D95F02"),
                    labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Average Leq", 
                    values = c("#1B9E77", "grey20", "#D95F02"),
                    labels = c("-69", "-64", "-55")) +
  th
```

Let's test each site separately to test the null hypothesis that there is not a majority of spiders choosing one side or the other (50%). Let's test the models with and without age and choose the best fit model.

```{r binomial site difference, echo = FALSE, warning = FALSE, message = FALSE}
choice_8B_scaled <- choice_8B %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)))
binom_8B <- glm(side ~ Age + condition, data = choice_8B_scaled, family = binomial(link = 'logit'))
binom_8B <- step(binom_8B)

coef_binom_8B <- round(data.frame(coef(summary(binom_8B))), 3) %>% 
  mutate(Site = "8B",
         Leq = -55)
  
choice_8A_scaled <- choice_8A %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)))
binom_8A <- glm(side ~ Age + condition, data = choice_8A_scaled, family = binomial(link = 'logit'))
binom_8A <- step(binom_8A)

coef_binom_8A <- round(data.frame(coef(summary(binom_8A))), 3) %>% 
  mutate(Site = "8A",
         Leq = -64)

choice_6C_scaled <- choice_6C %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)))
binom_6C <- glm(side ~ Age + condition, data = choice_6C_scaled, family = binomial(link = 'logit'))
binom_6C <- step(binom_6C)

coef_binom_6C <- round(data.frame(coef(summary(binom_6C))), 3) %>% 
  mutate(Site = "6C",
         Leq = -69)

choice_5A_scaled <- choice_5A %>% 
  mutate(Age = c(scale(Age)),
         condition = c(scale(condition)))
binom_5A <- glm(side ~ Age + condition, data = choice_5A_scaled, family = binomial(link = 'logit'))
binom_5A <- step(binom_5A)

coef_binom_5A <- round(data.frame(coef(summary(binom_5A))), 3) %>% 
  mutate(Site = "5A",
         Leq = -69)

rbind(coef_binom_8B, coef_binom_8A, coef_binom_6C, coef_binom_5A)
```

The loudest site (Site 8B) differs significantly from 50%, but the others do not. We get the same results with or without age. 

```{r other binomial stats, include = FALSE, warning = FALSE, message = FALSE}
# Site as ordinal
binom_ord <- glm(side ~ Site_ord * Age + Site_ord * condition, data = choice_scaled, family = binomial(link = 'logit'))
drop1(binom_ord, test = "Chisq")
binom_ord2 <- update(binom_ord, .~. -Site_ord:condition)
drop1(binom_ord2, test = "Chisq")
binom_ord3 <- update(binom_ord2, .~. -condition)
drop1(binom_ord3, test = "Chisq")
binom_ord4 <- update(binom_ord3, .~. -Site_ord:Age)
drop1(binom_ord4, test = "Chisq")
binom_ord5 <- update(binom_ord4, .~. -Age)
drop1(binom_ord5, test = "Chisq")
summary(binom_ord5)

binom_ord <- glm(side ~ Site_ord2 * Age + Site_ord2 * condition, data = choice_scaled, family = binomial(link = 'logit'))
drop1(binom_ord, test = "Chisq")
binom_ord2 <- update(binom_ord, .~. -Site_ord2:condition)
drop1(binom_ord2, test = "Chisq")
binom_ord3 <- update(binom_ord2, .~. -condition)
drop1(binom_ord3, test = "Chisq")
summary(binom_ord3)

# using origin
binom_org <- glm(side ~ Origin * Age + Origin * condition, data = choice_scaled, family = binomial)
drop1(binom_org, test = "Chisq")
binom_org2 <- update(binom_org, .~. -Origin:condition)
drop1(binom_org2, test = "Chisq")
binom_org3 <- update(binom_org2, .~. -condition)
drop1(binom_org3, test = "Chisq")
summary(binom_org3)

# origin subsets
choice_urban <- choice %>% 
  filter(Origin == "Urban")
binom_u <- glm(side ~ Age, data = choice_urban, family = binomial(link = 'logit'))
summary(binom_u)
choice_rural <- choice %>% 
  filter(Origin == "Rural")
binom_r <- glm(side ~ Age, data = choice_rural, family = binomial(link = 'logit'))
summary(binom_r)

binom_all <- glm(side ~ Age, data = choice, family = binomial(link = 'logit'))
summary(binom_all)
```

Results are similar when we use site as ordinal, but only with the order 5A, 6C, 8A, 8B, not 6C, 5A, 8A, 8B. Results are similar for origin (urban choose loud, rural no choice). 

Last, let's check that there is not a side (left vs right) preference.

```{r left vs right, echo = FALSE, warning = FALSE, message = FALSE}
data.frame(round(coef(summary(glm(side_lr ~ mean_leq * Age, data = choice_scaled, family = binomial(link = "logit")))), 3))
```

**Assumption 1: linearity between between predictor and the logit of the outcome**

```{r binomial assumption 1, echo = FALSE,  warning = FALSE, message = FALSE}
q_Age <- quantile(choice_scaled$Age, probs = c(0, 0.25, 0.5, 0.75, 1))
Age1 <- mean(choice_scaled$side[choice_scaled$Age < q_Age[2]])
Age2 <- mean(choice_scaled$side[choice_scaled$Age >= q_Age[2] & choice_scaled$Age < q_Age[3]])
Age3 <- mean(choice_scaled$side[choice_scaled$Age >= q_Age[3] & choice_scaled$Age < q_Age[4]])
Age4 <- mean(choice_scaled$side[choice_scaled$Age >= q_Age[4]])
probs_Age <- c(Age1, Age2, Age3, Age4)
logits_Age <- log(probs_Age / (1 - probs_Age))
meds_Age <- c(median(choice_scaled$Age[choice_scaled$Age < q_Age[2]]),
          median(choice_scaled$Age[choice_scaled$Age >= q_Age[2] & choice_scaled$Age < q_Age[3]]),
          median(choice_scaled$Age[choice_scaled$Age >= q_Age[3] & choice_scaled$Age < q_Age[4]]),
          median(choice_scaled$Age[choice_scaled$Age >= q_Age[4]])
          )

#Site1 <- mean(choice_scaled$side[choice_scaled$Site_ord == 1])
#Site2 <- mean(choice_scaled$side[choice_scaled$Site_ord == 2])
#Site3 <- mean(choice_scaled$side[choice_scaled$Site_ord == 3])
#Site4 <- mean(choice_scaled$side[choice_scaled$Site_ord == 4])
#probs_Site <- c(Site1, Site2, Site3, Site4)
#logits_Site <- log(probs_Site / (1 - probs_Site))
#meds_Site <- c(median(choice_scaled$Site_ord[choice_scaled$Site_ord == 1]),
#          median(choice_scaled$Site_ord[choice_scaled$Site_ord == 2]),
#          median(choice_scaled$Site_ord[choice_scaled$Site_ord == 3]),
#          median(choice_scaled$Site_ord[choice_scaled$Site_ord == 4])
#          )

leq1 <- mean(choice_scaled$side[choice_scaled$mean_leq == min(choice_scaled$mean_leq)])
leq2 <- mean(choice_scaled$side[choice_scaled$mean_leq == median(choice_scaled$mean_leq)])
leq3 <- mean(choice_scaled$side[choice_scaled$mean_leq == max(choice_scaled$mean_leq)])
probs_leq <- c(leq1, leq2, leq3)
logits_leq <- log(probs_leq / (1 - probs_leq))
meds_leq <- c(median(choice_scaled$mean_leq[choice_scaled$mean_leq == min(choice_scaled$mean_leq)]),
          median(choice_scaled$mean_leq[choice_scaled$mean_leq == median(choice_scaled$mean_leq)]),
          median(choice_scaled$mean_leq[choice_scaled$mean_leq == max(choice_scaled$mean_leq)])
          )

par(mfrow = c(1,2))
plot(meds_Age, logits_Age)
abline(lm(logits_Age ~ meds_Age))
#plot(meds_Site, logits_Site)
#abline(lm(logits_Site ~ meds_Site))
plot(meds_leq, logits_leq)
abline(lm(logits_leq ~ meds_leq))

```

This looks pretty good. 

**Assumption 2: no outliers**

```{r binomial assumption 2, echo = FALSE,  warning = FALSE, message = FALSE}
model.data <- augment(binom_leq) %>% 
  mutate(index = 1:n()) 
model.data %>% 
  filter(abs(.std.resid) > 3)
```

No outliers.

**Assumption 3: no multicollinearity**

```{r binomial assumption 3, echo = FALSE,  warning = FALSE, message = FALSE}
vif(binom_leq)
```

No highly correlated. Let's graph the results:

```{r binomial site graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
# no age
binom_8B2 <- glm(side ~ 1, data = choice_8B_scaled, family = binomial(link = 'logit'))
pred_8B = expand.grid(Site = "8B")
pred_8B <- add_column(pred_8B, fit = predict(binom_8B2, type = "response", newdata = pred_8B),
                      se = predict(binom_8B2, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit)

pred_8A = expand.grid(Site = "8A")
pred_8A <- add_column(pred_8A, fit = predict(binom_8A, type = "response", newdata = pred_8A),
                      se = predict(binom_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit)

pred_6C = expand.grid(Site = "6C")
pred_6C <- add_column(pred_6C, fit = predict(binom_6C, type = "response", newdata = pred_6C),
                      se = predict(binom_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit)

binom_5A2 <- glm(side ~ 1, data = choice_5A_scaled, family = binomial(link = 'logit'))
pred_5A = expand.grid(Site = "5A")
pred_5A <- add_column(pred_5A, fit = predict(binom_5A2, type = "response", newdata = pred_5A),
                      se = predict(binom_5A2, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit)

pred_noage <- rbind(pred_8B, pred_8A, pred_6C, pred_5A)

stacked_noage <- choice %>% 
  group_by(Site) %>% 
  count(side_w_more) %>% 
  mutate(side_w_more = fct_relevel(side_w_more, "quiet", "loud")) 

nval_noage <- choice %>% 
  group_by(Site) %>% 
  count() 

binom_noage <- ggplot() +
  geom_bar(aes(fill = side_w_more, y = n, x = Site), position="fill", stat="identity", data = stacked_noage, alpha = 0.75) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_point(aes(x = Site, y = fit), data = pred_noage, size = 1.5) +
  geom_errorbar(aes(x = Site, ymin = fit - se, ymax = fit + se), data = pred_noage, width = 0.15) +
  geom_text(aes(x = Site, y = 1.05, label = paste("n = ", n)), data = nval_noage, size = 3) +
  scale_x_discrete(labels = c("5A" = "5A \n(-69)", "6C" = "6C \n(-69)", "8A" = "8A \n(-64)", "8B" = "8B \n(-55)")) +
  scale_fill_manual("Side with \nMore Silk", 
                    values = c("#1B9E77", "#D95F02"),
                    labels = c("Quiet", "Loud")) +
  xlab("Site \n(Site Average Leq dB)") +
  ylab("Proportion of Spiders") +
  th +
  theme(legend.position = "top")

# age
pred_8B = expand.grid(Site = "8B",
                Age = seq(-2.5, 2.5, 0.05)) 
pred_8B <- add_column(pred_8B, fit = predict(binom_8B, type = "response", newdata = pred_8B),
                      se = predict(binom_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit)

pred_5A = expand.grid(Site = "5A",
                Age = seq(-2.5, 2.5, 0.05)) 
pred_5A <- add_column(pred_5A, fit = predict(binom_5A, type = "response", newdata = pred_5A),
                      se = predict(binom_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit)

pred_8B$Age = pred_8B$Age * sd(choice$Age) + mean(choice$Age)

binom_age_8B <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.5, ymax = 1.2), fill = "#D95F02", alpha = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -0.25, ymax = 0.5), fill = "#1B9E77", alpha = 0.5) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line(aes(x = Age, y = fit), data = pred_8B) +
  geom_ribbon(aes(x = Age, ymin = fit - (1.96 * se), ymax = fit + (1.96 * se)), data = pred_8B, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 50), breaks = c(0, 10, 20, 30, 40, 50), expand = c(0,0)) +
  scale_y_continuous(limits = c(-0.25, 1.2), breaks = c(-0.25, 0, 0.25, 0.5, 0.75, 1), expand = c(0,0)) +
  annotate("text", label = "P = 0.083", x = 25, y = 1.1, size = 3) +
  xlab("Age (Days) \n8B (-55 dB)") +
  ylab("") +
  th 

pred_5A$Age = pred_5A$Age * sd(choice$Age) + mean(choice$Age)

binom_age_5A <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.5, ymax = 1.2), fill = "#D95F02", alpha = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -0.25, ymax = 0.5), fill = "#1B9E77", alpha = 0.5) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line(aes(x = Age, y = fit), data = pred_5A) +
  geom_ribbon(aes(x = Age, ymin = fit - (1.96 * se), ymax = fit + (1.96 * se)), data = pred_5A, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 50), breaks = c(0, 10, 20, 30, 40, 50), expand = c(0,0)) +
  scale_y_continuous(limits = c(-0.25, 1.2), breaks = c(-0.25, 0, 0.25, 0.5, 0.75, 1), expand = c(0,0)) +
  annotate("text", label = "P = 0.141", x = 25, y = 1.1, size = 3) +
  xlab("Age (Days) \n5A (-69 dB)") +
  ylab("") +
  th

binom <- ggarrange(binom_noage, binom_age_5A, binom_age_8B, nrow = 1, widths = c(0.4, 0.3, 0.3), common.legend = TRUE)

jpeg("figures/binom.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(binom)
dev.off()
binom
```

## Proportion of Silk on Each Side (Excluding Tunnel)

**tl:dr:** We used a beta regression (with GAM betar) to look at choice on a more continuous scale (i.e., each spider's proportion of silk in loud). We find similar results to the logistic regression. Spiders also increase the proportion of tunnel silk with increasing leq.

Let's make the spider's choice more continuous than a yes/no question. We can look at the proportion of each spider's silk that was placed on the loud side.  

```{r prop loud quiet exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice %>% 
    ggplot() +
  geom_point(aes(x = mean_leq, y = propl, color = factor(mean_leq))) +
  geom_smooth(aes(x = mean_leq, y = propl), color = "black") +
  theme(legend.position = "top")

Age_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = Age, y = propl, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = propl), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = condition, y = propl, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = propl), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

Let's first look across site leq as we did before. We will use the buildglmmTMB to do backwards selection on a beta regression. 

```{r beta for leq, echo = FALSE, warning = FALSE, message = FALSE}
beta_leq <- betareg(propl ~ mean_leq * Age + mean_leq * condition, data = choice_scaled)
summary(beta_leq) # same as for beta with gam

#summary(buildglmmTMB(propl ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit")))
# ID and condition removed

beta_leq_gam <- gam(propl ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = betar(link = "logit"))
beta_leq_gam2 <- gam(propl ~ mean_leq * poly(Age, 2) + mean_leq * poly(condition, 2), data = choice_scaled, family = betar(link = "logit"))
anova(beta_leq_gam, beta_leq_gam2, test = "Chisq") # no polys better
beta_leq_gam3 <- gam(propl ~ mean_leq * Age + mean_leq * poly(condition, 2), data = choice_scaled, family = betar(link = "logit"))
anova(beta_leq_gam, beta_leq_gam3, test = "Chisq") # no polys better
beta_leq_gam4 <- gam(propl ~ mean_leq * poly(Age, 2) + mean_leq * condition, data = choice_scaled, family = betar(link = "logit"))
anova(beta_leq_gam, beta_leq_gam4, test = "Chisq") # no polys better

beta_leq_gam <- gam(propl ~ mean_leq * Age, data = choice_scaled, family = betar(link = "logit"))
summary(beta_leq_gam)

#simulateResiduals(beta_leq_gam, plot = TRUE)
```

Let's test each site for choices that significantly differ from 50%. 

```{r beta for site differences, echo = FALSE, warning = FALSE, message = FALSE}
#summary(buildglmmTMB(propl ~ Age + (1|ID), data = choice_8B, family = list(family = "beta", link = "logit"))) # ID removed
beta_leq_gam_8B_age <- gam(propl ~ Age, data = choice_8B, family = betar(link = "logit"))
summary(beta_leq_gam_8B_age)
coef_beta_8B_age <- round(data.frame(estimates = summary(beta_leq_gam_8B_age)$p.coeff,
                                 se = summary(beta_leq_gam_8B_age)$se,
                                 z = summary(beta_leq_gam_8B_age)$p.t,
                                 p = summary(beta_leq_gam_8B_age)$p.pv),
                                 3) %>% 
  mutate(Site = "8B",
         Leq = -55)


#summary(buildglmmTMB(propl ~ Age + (1|ID), data = choice_8A, family = list(family = "beta", link = "logit"))) # ID and Age removed
beta_leq_gam_8A <- gam(propl ~ 1, data = choice_8A, family = betar(link = "logit"))
summary(beta_leq_gam_8A)
coef_beta_8A <- round(data.frame(estimates = summary(beta_leq_gam_8A)$p.coeff,
                                 se = summary(beta_leq_gam_8A)$se,
                                 z = summary(beta_leq_gam_8A)$p.t,
                                 p = summary(beta_leq_gam_8A)$p.pv),
                                 3) %>% 
  mutate(Site = "8A",
         Leq = -64)


#summary(buildglmmTMB(propl ~ Age + (1|ID), data = choice_6C, family = list(family = "beta", link = "logit"))) # ID and Age removed
beta_leq_gam_6C <- gam(propl ~ 1, data = choice_6C, family = betar(link = "logit"))
summary(beta_leq_gam_6C)
coef_beta_6C <- round(data.frame(estimates = summary(beta_leq_gam_6C)$p.coeff,
                                 se = summary(beta_leq_gam_6C)$se,
                                 z = summary(beta_leq_gam_6C)$p.t,
                                 p = summary(beta_leq_gam_6C)$p.pv),
                                 3) %>% 
  mutate(Site = "6C",
         Leq = -69)


#summary(buildglmmTMB(propl ~ Age + (1|ID), data = choice_5A, family = list(family = "beta", link = "logit"))) # ID and Age removed
beta_leq_gam_5A <- gam(propl ~ 1, data = choice_5A, family = betar(link = "logit"))
summary(beta_leq_gam_5A)
coef_beta_5A <- round(data.frame(estimates = summary(beta_leq_gam_5A)$p.coeff,
                                 se = summary(beta_leq_gam_5A)$se,
                                 z = summary(beta_leq_gam_5A)$p.t,
                                 p = summary(beta_leq_gam_5A)$p.pv),
                                 3) %>% 
  mutate(Site = "5A",
         Leq = -69)

rbind(coef_beta_8B_age, coef_beta_8A, coef_beta_6C, coef_beta_5A)
```

Again, only 8B significantly differs from 50% and differs by age. 

```{r origin test for beta, eval = FALSE, warning = FALSE, message = FALSE}
beta_origin <- buildglmmTMB(propl ~ Origin * Age + Origin * condition, data = choice_scaled, family = list(family = "beta", link = "logit"))
summary(beta_origin) #Origin:Age
```

```{r looking at tunnel separate test, eval = FALSE, warning = FALSE, message = FALSE}
#beta_leq_tunnel <- buildglmmTMB(propt_tunnel ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit"))
beta_leq_tunnel <- gam(propt_tunnel ~ mean_leq, data = choice, family = betar(link = "logit"))
summary(beta_leq_tunnel) # meanleq - sig positive

beta_leql_tunnel <- buildglmmTMB(propl_tunnel ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit"))
summary(beta_leql_tunnel) # meanleq * age sig

beta_leqq_tunnel <- buildglmmTMB(propq_tunnel ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit"))
summary(beta_leqq_tunnel) # meanleq * age sig

beta_leq_tunnel_8B <- gam(propt_tunnel ~ Age, data = choice_8B, family = betar(link = "logit"))
summary(beta_leq_tunnel_8B)

beta_leq_tunnel_8A <- gam(propt_tunnel ~ Age, data = choice_8A, family = betar(link = "logit"))
summary(beta_leq_tunnel_8A)

beta_leq_tunnel_6C <- gam(propt_tunnel ~ Age, data = choice_6C, family = betar(link = "logit"))
summary(beta_leq_tunnel_6C)

beta_leq_tunnel_5A <- gam(propt_tunnel ~ Age, data = choice_5A, family = betar(link = "logit"))
summary(beta_leq_tunnel_5A)
#no age effects with silk in tunnel
```

```{r adding proportion silk in tunnel, echo = FALSE, warning = FALSE, message = FALSE}
choice_part <- choice %>% 
  pivot_longer(propl_tunnel:propt_tunnel, values_to = "prop_part", names_to = "part") %>% 
  mutate(part = fct_recode(part, "loud" = "propl_tunnel", "quiet" = "propq_tunnel", "tunnel" = "propt_tunnel"))
choice_part_scaled <- choice_part %>% 
  mutate(Age = c(scale(Age)),
         mean_leq = c(scale(mean_leq)),
         condition = c(scale(condition)))

summary(buildglmmTMB(prop_part ~ part * mean_leq * Age + part * mean_leq * condition + (1|ID), data = choice_part_scaled, family = list(family = "beta", link = "logit"))) # keep part * mean_leq * Age

beta_leqt <- gam(prop_part ~ part * mean_leq + part * Age + part:mean_leq:Age, data = choice_part_scaled, family = betar(link = "logit"))
anova(beta_leqt)
summary(beta_leqt)
lstrends(beta_leqt, pairwise ~ part, var = "mean_leq", at = list(Age = quantile(choice_part_scaled$Age, 0.25)))
lstrends(beta_leqt, pairwise ~ part, var = "mean_leq", at = list(Age = quantile(choice_part_scaled$Age, 0.5)))
lstrends(beta_leqt, pairwise ~ part, var = "mean_leq", at = list(Age = quantile(choice_part_scaled$Age, 0.75)))
```

**Assumptions**

```{r beta assumptions, echo = FALSE,  warning = FALSE, message = FALSE}
test_beta <- augment(beta_leq_gam, data = choice_scaled)
resid_beta <- ggplot(test_beta, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_beta$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_beta <- ggplot(test_beta, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

test_beta$.std.resid <- residuals(beta_leq_gam, type = "deviance")
scale_loc_beta <- ggplot(test_beta, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_beta <- ggplot(test_beta, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()


annotate_figure(ggarrange(resid_beta, qq_beta, scale_loc_beta, cook_beta,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Beta Prop Silk"))

test_beta %>% 
  filter(abs(.std.resid) > 3)
```

**Graph**

```{r beta leq graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
labs <- c("Point: Raw Data < Median Age \nLine: Predictions at 1st Quartile Age",
          "Points: Raw Data >= Median Age \nLine: Predictions at 3rd Quartile Age")
names(labs) <- c("15", "32")

choice2 <- choice%>% 
  mutate(Age = ifelse(Age < median(Age), "15", "32"))

pred <- expand.grid(mean_leq = seq(-1, 1.4, 0.02),
                 Age = quantile(choice_scaled$Age, probs = c(0.25, 0.75)))
pred <- add_column(pred, fit = predict(beta_leq_gam, newdata = pred, type = "response"),
                 se = predict(beta_leq_gam, newdata = pred, type = "response", se.fit = TRUE)$se.fit)
# back transform
pred$mean_leq = pred$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq)
pred$Age = pred$Age * sd(choice$Age) + mean(choice$Age)

prop_leq <- ggplot() +
  geom_rect(data=data.frame(Age=factor(c(15, 32))), aes(xmin = -70, xmax = -54, ymin = 0.5, ymax = 1, group = Age), fill = "#D95F02", alpha = 0.5) +
  geom_rect(data=data.frame(Age=factor(c(15, 32))), aes(xmin = -70, xmax = -54, ymin = 0, ymax = 0.5, group = Age), fill = "#1B9E77", alpha = 0.5) +
  geom_point(aes(x=mean_leq, y = propl), data = choice2, alpha = 0.75, color = "grey20") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line(aes(x = mean_leq, y = fit, group = factor(Age)), data = pred) +
  geom_ribbon(aes(x = mean_leq, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96), group = factor(Age)), data = pred, alpha = 0.5) +
  scale_x_continuous(limits = c(-70, -54), breaks = c(-69, -64, -55), expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 1.1), breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0,0)) +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  ylab("Proportion of Silk on the Loud Side") +
  th +
  facet_wrap(~Age, labeller = labeller(Age = labs))

jpeg("figures/prop_leq.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(prop_leq)
dev.off()
prop_leq

# another way to view
nd = expand.grid(mean_leq = c(-0.8889257, -0.1045795, 1.3072437),
                Age = seq(-2.5, 2.5, 0.2))
nd <- add_column(nd, fit = predict(beta_leq_gam, newdata = nd, type = "response"),
                 se = predict(beta_leq_gam, newdata = nd, type = "response", se.fit = TRUE)$se.fit)
# back transform
nd$Age = nd$Age * sd(choice$Age) + mean(choice$Age)
nd$mean_leq = round(nd$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq), 0)

nd %>% 
ggplot(aes(x = Age, y = fit, group = factor(mean_leq), color = factor(mean_leq), fill = factor(mean_leq))) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_line() +
  geom_ribbon(aes(ymin = fit - (se * 1.96), ymax = fit + (se * 1.96)), alpha = 0.5) +
  ylab("Proportion of Spiders") +
  xlab("Age (days since maturation)") +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  scale_fill_manual("Site Average Leq", 
                    values = c("#1B9E77", "grey20", "#D95F02"),
                    labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Average Leq", 
                    values = c("#1B9E77", "grey20", "#D95F02"),
                    labels = c("-69", "-64", "-55")) +
  th +
  facet_wrap(~ mean_leq)
```

```{r beta site graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
# age
pred_8B_age = expand.grid(Site = "8B",
                Age = seq(0, 50, 1)) 
pred_8B_age <- add_column(pred_8B_age, fit = predict(beta_leq_gam_8B_age, type = "response", newdata = pred_8B_age),
                      se = predict(beta_leq_gam_8B_age, type = "response", newdata = pred_8B_age, se.fit = TRUE)$se.fit)

# no age
beta_leq_gam_8B <- gam(propl ~ 1, data = choice_8B, family = betar(link = "logit"))
pred_8B = expand.grid(Site = "8B")
pred_8B <- add_column(pred_8B, fit = predict(beta_leq_gam_8B, type = "response", newdata = pred_8B),
                      se = predict(beta_leq_gam_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit)

pred_8A = expand.grid(Site = "8A")
pred_8A <- add_column(pred_8A, fit = predict(beta_leq_gam_8A, type = "response", newdata = pred_8A),
                      se = predict(beta_leq_gam_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit) 

pred_6C = expand.grid(Site = "6C")
pred_6C <- add_column(pred_6C, fit = predict(beta_leq_gam_6C, type = "response", newdata = pred_6C),
                      se = predict(beta_leq_gam_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit)

pred_5A = expand.grid(Site = "5A")
pred_5A <- add_column(pred_5A, fit = predict(beta_leq_gam_5A, type = "response", newdata = pred_5A),
                      se = predict(beta_leq_gam_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit)

pred <- rbind(pred_8B, pred_8A, pred_6C, pred_5A) #pred_all

nval <- choice %>% 
  group_by(Site) %>% 
  count() 

pred_8B_age <- pred_8B_age %>% 
  mutate(lower = pred_8B_age$fit - (1.96 *pred_8B_age$se))

prop_site_8B <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.5, ymax = 1), fill = "#D95F02", alpha = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = 0.5), fill = "#1B9E77", alpha = 0.5) +
  geom_point(aes(x = Age, y = propl), data = choice_8B, alpha = 0.75, color = "grey20") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_segment(aes(x = 24, xend = 24, y = 0, yend = 1), linetype = 2) +
  geom_line(aes(x = Age , y = fit), data = pred_8B_age, size = 2) +
  geom_ribbon(aes(x = Age, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96)), data = pred_8B_age, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 50), breaks = c(0, 10, 20, 24, 30, 40, 50), expand = c(0,0 )) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0,0 )) +
  xlab("Age (Days since Maturation) \n8B (-55 dB)") +
  ylab("Proportion of Silk on the Loud Side") +
  th +
  theme(axis.title.y = element_blank())

prop_site <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.5, ymax = 1), fill = "#D95F02", alpha = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = 0.5), fill = "#1B9E77", alpha = 0.5) +
  geom_point(aes(x = Site, y = propl), data = choice, alpha = 0.75, color = "grey20") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_point(aes(x = Site, y = fit), data = pred, size = 1.5, position = position_nudge(x = 0.25)) +
  geom_errorbar(aes(x = Site, ymin = fit - se, ymax = fit + se), data = pred, width = 0.15, position = position_nudge(x = 0.25)) +
  geom_text(aes(x = Site, y = 1.05, label = paste("n = ", n)), data = nval, size = 3) +
scale_x_discrete(labels = c("5A" = "5A \n(-69 dB)", "6C" = "6C \n(-69 dB)", "8A" = "8A \n(-64 dB)", "8B" = "8B \n(-55 dB)")) +
  scale_fill_manual("Side with \nMore Silk", 
                    values = c("#1B9E77", "#D95F02"),
                    labels = c("Quiet", "Loud")) +
  xlab("") +
  ylab("Proportion of Silk on the Loud Side") +
  th 

prop_site_all <- ggarrange(prop_site, prop_site_8B, nrow = 1, common.legend = TRUE)

jpeg("figures/prop_site_all.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(prop_site_all)
dev.off()
prop_site_all
```

```{r tunnel graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred <- expand.grid(mean_leq = seq(-1, 1.4, 0.1),
                    Age = quantile(choice_part_scaled$Age, probs = c(0.25, 0.5, 0.75)),
                    part = levels(choice_part_scaled$part))
pred <- add_column(pred, fit = predict(beta_leqt, newdata = pred, type = "response"),
                 se = predict(beta_leqt, newdata = pred, type = "response", se.fit = TRUE)$se.fit)
pred$Age = round(pred$Age * sd(choice$Age) + mean(choice$Age), 0)
pred$mean_leq = pred$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq)

choice_part2 <- choice_part %>% 
  mutate(Age = ifelse(Age < median(Age), "15", "32"),
         Age = as.numeric(Age))
ggplot() +
  geom_point(aes(x = mean_leq, y = prop_part, group = part, color = part), data = choice_part2) +
  geom_line(aes(x = mean_leq, y = fit, group = part, color = part), data = pred) +
  geom_ribbon(aes(x = mean_leq, y = fit, ymin = fit - (1.96 * se), ymax = fit + (1.96 * se), group = part, fill = part), alpha = 0.5, data = pred) +
  scale_fill_manual("Part", 
                    values = c("#D95F02", "#1B9E77", "grey20"),
                    labels = c("Loud", "Quiet", "Tunnel")) +
  scale_color_manual("Part", 
                    values = c("#D95F02", "#1B9E77", "grey20"),
                    labels = c("Loud", "Quiet", "Tunnel")) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  ylab("Proportion of Silk") +
  th +
  facet_wrap(~Age)
```

## Total Silk Use

**tl;dr:** We used a negative binomial regression to test for differences in total silk use. Body condition had no effect. Total silk mass (without the tunnel) marginally decreased with site average Leq and significantly increased with age (especially for 8B and 6C). When we include silk mass in the tunnel in the total, leq is not significant (spiders from louder allocate silk to the tunnel). 

Next we want to know if there are any overall changes in the amount of silk used. Proportional changes can be caused by a number of different changes. Increased proportion of silk on the loud side could mean:

- increase in overall silk, more silk in loud without change in quiet

- decrease in overall silk, less silk in quiet without change in loud

- same silk overall, adds less silk to quiet and more to loud

```{r total loud quiet tunnel exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice %>% 
    ggplot() +
  geom_point(aes(x = mean_leq, y = total_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = mean_leq, y = total_micro), color = "black") +
  theme(legend.position = "top")

Age_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = Age, y = total_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = total_micro), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = condition, y = total_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = total_micro), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

Let's look at the total silk mass used (only in loud + quiet). Let's use a negative binomial since the data is positive, interger with no upper bound, but overdispersion.

```{r total silk stats, echo = FALSE, warning = FALSE, message = FALSE}
total <- glm.nb(total_micro ~ mean_leq * Age + mean_leq * condition, data = choice_scaled)
total <- step(total)
#drop1(total, test = "Chisq")
#total2 <- update(total, .~. -mean_leq:condition)
#drop1(total2, test = "Chisq")
#total3 <- update(total2, .~. -condition)
#drop1(total3, test = "Chisq")
#total4 <- update(total3, .~. -mean_leq:Age)
#drop1(total4, test = "Chisq")
summary(total)
with(summary(total), 1 - deviance/null.deviance)
```

Only age and origin leq remained in the model.

Let's also include tunnel silk in the total.

```{r total loud quiet tunnel exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice %>% 
    ggplot() +
  geom_point(aes(x = mean_leq, y = total_micro_tunnel, color = factor(mean_leq))) +
  geom_smooth(aes(x = mean_leq, y = total_micro_tunnel), color = "black") +
  theme(legend.position = "top")

Age_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = Age, y = total_micro_tunnel, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = total_micro_tunnel), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = condition, y = total_micro_tunnel, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = total_micro_tunnel), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

```{r total silk with tunnel stats, echo = FALSE, warning = FALSE, message = FALSE}
total_tunnel <- glm.nb(total_micro_tunnel ~ mean_leq * Age + mean_leq * condition, data = choice_scaled)
total_tunnel <- step(total_tunnel)
#drop1(total_tunnel, test = "Chisq")
#total_tunnel2 <- update(total_tunnel, .~. -mean_leq:condition)
#drop1(total_tunnel2, test = "Chisq")
#total_tunnel3 <- update(total_tunnel2, .~. -condition)
#drop1(total_tunnel3, test = "Chisq")
#total_tunnel4 <- update(total_tunnel3, .~. -mean_leq:Age)
#drop1(total_tunnel4, test = "Chisq")
#total_tunnel5 <- update(total_tunnel4, .~. -mean_leq)
#drop1(total_tunnel5, test = "Chisq")
summary(total_tunnel)
with(summary(total_tunnel), 1 - deviance/null.deviance)
```

Only age was significant in the model.

Let's look at each site. 

```{r total silk of each site, echo = FALSE, warning = FALSE, message = FALSE}
total_8B <- glm.nb(total_micro ~ Age + condition, data = choice_8B)
total_8B <- step(total_8B) # age
total_tunnel_8B <- glm.nb(total_micro_tunnel ~ Age + condition, data = choice_8B) 
total_tunnel_8B <- step(total_tunnel_8B) # age
summary(total_tunnel_8B)
coef_8B <- data.frame(round(coef(summary(total_tunnel_8B)), 3),
                      Site = "8B",
                      mean_leq = -55)

total_8A <- glm.nb(total_micro ~ Age + condition, data = choice_8A)
total_8A <- step(total_8A) # age
total_tunnel_8A <- glm.nb(total_micro_tunnel ~ Age + condition, data = choice_8A)
total_tunnel_8A <- step(total_tunnel_8A) # not age
summary(total_tunnel_8A)
coef_8A <- data.frame(round(coef(summary(total_tunnel_8A)), 3),
                      Site = "8A",
                      mean_leq = -64)

total_6C <- glm.nb(total_micro ~ Age + condition, data = choice_6C)
total_6C <- step(total_6C) # age
total_tunnel_6C <- glm.nb(total_micro_tunnel ~ Age + condition, data = choice_6C) 
total_tunnel_6C <- step(total_tunnel_6C) # age
summary(total_tunnel_6C)
coef_6C <- data.frame(round(coef(summary(total_tunnel_6C)), 3),
                      Site = "6C",
                      mean_leq = -69)

total_5A <- glm.nb(total_micro ~ Age + condition, data = choice_5A)
total_5A <- step(total_5A) # age
total_tunnel_5A <- glm.nb(total_micro_tunnel ~ Age + condition, data = choice_5A)
total_tunnel_5A <- step(total_tunnel_5A) # none
summary(total_tunnel_5A)
coef_5A <- data.frame(round(coef(summary(total_tunnel_5A)), 3),
                      Site = "5A",
                      mean_leq = -69)

rbind(coef_8B, coef_8A, coef_6C, coef_5A)
```

Age only effects silk mass (with and without tunnel) in 8B and 6C. 

Let's check the assumptions.

```{r total silk assumptions, echo = FALSE, warning = FALSE, message = FALSE}
test_silk <- augment(total_tunnel, data = choice_scaled)
resid_silk <- ggplot(test_silk, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_silk$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_silk <- ggplot(test_silk, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

scale_loc_silk <- ggplot(test_silk, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_silk <- ggplot(test_silk, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()


annotate_figure(ggarrange(resid_silk, qq_silk, scale_loc_silk, cook_silk,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Neg Binom Prop Total Silk"))

test_silk %>% 
  filter(abs(.std.resid) > 3)
```

Looks good. Let's make some graphs!

```{r leq total silk graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred = expand.grid(mean_leq = quantile(choice_scaled$mean_leq, probs = c(0, 0.5, 1)),
                 Age = seq(-2.5, 2.5, 0.05))
pred <- add_column(pred, fit = data.frame(predict(total_tunnel, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(total_tunnel, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(choice$mean_leq) + mean(choice$mean_leq)
pred$Age = pred$Age * sd(choice$Age) + mean(choice$Age)

#labs <- c("Points: Raw Data < Median Age \nLines: Predictions at 1st Quartile Age",
#          "Points: Raw Data >= Median Age \nLines: Predictions at 3rd Quartile Age")
#names(labs) <- c("15", "32")

ggplot() +
  geom_point(aes(x = mean_leq, y = total_micro_tunnel), data = choice2) +
  geom_line(aes(x = mean_leq, y = fit), data = pred) +
  geom_ribbon(aes(x = mean_leq, y = fit, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96)), data = pred, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 3100), breaks = c(0, 500, 1000, 1500, 2000, 2500, 3000)) +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  ylab("Total Silk Mass (g)") +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  th +
  facet_wrap(~Age, labeller = labeller(Age = labs))

total_silk <- ggplot() +
  geom_point(aes(x = Age, y = total_micro_tunnel, color = factor(mean_leq)), data = choice) +
  geom_line(aes(x = Age, y = fit, color = factor(mean_leq)), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (se), ymax = fit + (se), fill = factor(mean_leq)), data = pred, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 3100), breaks = c(0, 500, 1000, 1500, 2000, 2500, 3000)) +
  scale_fill_manual("Site Leq", 
                    values = c("#1b9e77", "#7570b3", "#d95f02"), 
                    labels = c("-69", "-64", "-55")) +
  scale_color_manual("Site Leq", 
                     values = c("#1b9e77", "#7570b3", "#d95f02"), 
                     labels = c("-69", "-64", "-55")) +
  ylab("Total Silk Mass (g)") +
  xlab("Age (Days Since Mature)") +
  th

jpeg("figures/total_silk.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(total_silk)
dev.off()
total_silk
```

```{r site total silk graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred_8B = expand.grid(Site = "8B",
                Age = seq(0, 50, 1)) 
pred_8B <- add_column(pred_8B, fit = predict(total_tunnel_8B, type = "response", newdata = pred_8B),
                      se = predict(total_tunnel_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit)

pred_8A = expand.grid(Site = "8A",
                Age = seq(0, 50, 1)) 
pred_8A <- add_column(pred_8A, fit = predict(total_tunnel_8A, type = "response", newdata = pred_8A),
                      se = predict(total_tunnel_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit)

pred_6C = expand.grid(Site = "6C",
                Age = seq(0, 50, 1)) 
pred_6C <- add_column(pred_6C, fit = predict(total_tunnel_6C, type = "response", newdata = pred_6C),
                      se = predict(total_tunnel_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit)

pred_5A = expand.grid(Site = "5A",
                Age = seq(0, 50, 1)) 
pred_5A <- add_column(pred_5A, fit = predict(total_tunnel_5A, type = "response", newdata = pred_5A),
                      se = predict(total_tunnel_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit)

pred <- rbind(pred_8B, pred_8A, pred_6C, pred_5A) %>% 
  mutate(Site = fct_relevel(Site, "8B", "8A", "6C", "5A"))

labels <- data.frame(Site = c("8B", "8A", "6C", "5A"),
  n = c(24, 11, 16, 18),
  p = c("< 0.001", "= 0.280", "= 0.039", "= 0.454")) %>% 
  mutate(Site = fct_relevel(Site, "8B", "8A", "6C", "5A"))

total_site <- ggplot() +
  geom_point(aes(x = Age, y = total_micro), data = choice) +
  geom_line(aes(x = Age, y = fit), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (1.96 * se), ymax = fit + (1.96 * se)), data = pred, alpha = 0.5) +
  geom_text(aes(x = 25, y = 3200, label = paste("n = ", n, "; p ", p)), data = labels, size = 3) +
  xlab("Age (Days since Maturation)") +
  ylab("Total Silk Mass (g)") +
  th +
  facet_wrap(~Site)

jpeg("figures/total_site.jpeg", width = 6.5, height = 6.5, units = "in", quality = 100, res = 300)
print(total_site)
dev.off()
total_site
```

## Amount of Silk on Each Side

**tl;dr:** We used a negative binomial to assess silk mass between loud and quiet sides (side) and it's interactions with leq, age, and condition. Condition was removed. A three-way interaction between side, leq, and age shows that the amount of loud silk did not change much with increasing leq but younger spiders from louder sites repressed quiet silk use. Older spiders did not show changes in silk use on the quiet side with increasing leq. This is mainly due to site 8B spiders increasing silk use in the quiet side with increasing age. 

So we know there is a trend that spiders used less silk when they were from louder sites, but more silk with age. This might suggest that as 8B spiders started adding more silk with age, they probably were putting similar amounts in the loud with increasing amounts in the quiet with age. 

```{r get silk data, echo = FALSE, warning = FALSE, message = FALSE}
choice_side <- choice %>% 
  dplyr::select(ID, Age, condition, mean_leq, Site, Origin, loud_silk, quiet_silk) %>% 
 pivot_longer(cols = c(loud_silk, quiet_silk), names_to = "side", values_to = "silk_mass") %>%
  mutate(side = fct_recode(side, "loud" = "loud_silk", "quiet" = "quiet_silk"),
         side = fct_relevel(side, "loud", "quiet"),
         silk_mass_micro = silk_mass * 1000)

choice_side_scaled <- choice_side %>% 
  mutate(mean_leq = c(scale(mean_leq)),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
```

Let's check the stats. We should use a negative binomial because the data appear to be overdispersed. We will similarly test leq with age and condition. 

```{r silk by part exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice_side %>% 
    ggplot() +
  geom_point(aes(x = mean_leq, y = silk_mass_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = mean_leq, y = silk_mass_micro), color = "black") +
  theme(legend.position = "top")

Age_raw <- choice_side %>% 
  ggplot() +
  geom_point(aes(x = Age, y = silk_mass_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = silk_mass_micro), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice_side %>% 
  ggplot() +
  geom_point(aes(x = condition, y = silk_mass_micro, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = silk_mass_micro), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

```{r silk mass by leq, echo = FALSE, warning = FALSE, message = FALSE}
#silk_side.nb <- glmer.nb(silk_mass_micro ~ side + mean_leq + Age + condition + side:mean_leq + side:Age + side:condition + side:mean_leq:Age + side: mean_leq:condition + (1|ID), data = choice_side_scaled)
#drop1(silk_side.nb, test = "Chisq")
#silk_side.nb2 <- update(silk_side.nb, .~. -side:mean_leq:condition)
#drop1(silk_side.nb2, test = "Chisq")
#silk_side.nb3 <- update(silk_side.nb2, .~. -side:condition)
#drop1(silk_side.nb3, test = "Chisq")
#silk_side.nb4 <- update(silk_side.nb3, .~. -condition)
#drop1(silk_side.nb4, test = "Chisq")
#summary(silk_side.nb4)
#kable(Anova(silk_side.nb4))
#same as without random factor

silk_side.nb <- glm.nb(silk_mass_micro ~ side + mean_leq + Age + condition + side:mean_leq + side:Age + side:condition + side:mean_leq:Age + side: mean_leq:condition, data = choice_side_scaled)
silk_side.nb <- step(silk_side.nb)
#drop1(silk_side.nb, test = "Chisq")
#silk_side.nb2 <- update(silk_side.nb, .~. -side:mean_leq:condition)
#drop1(silk_side.nb2, test = "Chisq")
#silk_side.nb3 <- update(silk_side.nb2, .~. -side:condition)
#drop1(silk_side.nb3, test = "Chisq")
#silk_side.nb4 <- update(silk_side.nb3, .~. -condition)
#drop1(silk_side.nb4, test = "Chisq")
#summary(silk_side.nb4)
Anova(silk_side.nb)
```

We see the same leq and age effect, but add a three-way interaction between leq, age, and side. We can also subset by site and look for differences. 

```{r silk mass by site, echo = FALSE, warning = FALSE, message = FALSE}
# with random effect
choice_side_8B <- choice_side %>% 
  filter(Site == "8B")
silk_side.nb_8B <- glmer.nb(silk_mass_micro ~ side * Age + (1|ID), data = choice_side_8B)
coef_8B <- data.frame(Anova(silk_side.nb_8B),
                      Site = "8B",
                      mean_leq = -55)

choice_side_8A <- choice_side %>% 
  filter(Site == "8A")
silk_side.nb_8A <- glmer.nb(silk_mass_micro ~ side * Age + (1|ID), data = choice_side_8A)
coef_8A <- data.frame(Anova(silk_side.nb_8A),
                      Site = "8A",
                      mean_leq = -64)

choice_side_6C <- choice_side %>% 
  filter(Site == "6C")
silk_side.nb_6C <- glmer.nb(silk_mass_micro ~ side * Age + (1|ID), data = choice_side_6C)
coef_6C <- data.frame(Anova(silk_side.nb_6C),
                      Site = "6C",
                      mean_leq = -69)

choice_side_5A <- choice_side %>% 
  filter(Site == "5A")
silk_side.nb_5A <- glmer.nb(silk_mass_micro ~ side * Age + (1|ID), data = choice_side_5A)
coef_5A <- data.frame(Anova(silk_side.nb_5A),
                      Site = "5A",
                      mean_leq = -69)

#rbind(coef_8B, coef_8A, coef_6C, coef_5A)

choice_side_8B <- choice_side %>% 
  filter(Site == "8B")
silk_side.nb_8B <- glm.nb(silk_mass_micro ~ side * Age, data = choice_side_8B)
coef_8B <- data.frame(Anova(silk_side.nb_8B),
                      Site = "8B",
                      mean_leq = -55)

choice_side_8A <- choice_side %>% 
  filter(Site == "8A")
silk_side.nb_8A <- glm.nb(silk_mass_micro ~ side * Age, data = choice_side_8A)
coef_8A <- data.frame(Anova(silk_side.nb_8A),
                      Site = "8A",
                      mean_leq = -64)

choice_side_6C <- choice_side %>% 
  filter(Site == "6C")
silk_side.nb_6C <- glm.nb(silk_mass_micro ~ side * Age, data = choice_side_6C)
coef_6C <- data.frame(Anova(silk_side.nb_6C),
                      Site = "6C",
                      mean_leq = -69)

choice_side_5A <- choice_side %>% 
  filter(Site == "5A")
silk_side.nb_5A <- glm.nb(silk_mass_micro ~ side * Age, data = choice_side_5A)
coef_5A <- data.frame(Anova(silk_side.nb_5A),
                      Site = "5A",
                      mean_leq = -69)

rbind(coef_8B, coef_8A, coef_6C, coef_5A)
```

We only see effects in 8B where silk increased with age and an interaction revealed that silk mass in loud did not change with age, but quiet silk mass increased with age. 
Let's check the assumptions.

```{r silk mass assumptions, echo = FALSE, warning = FALSE, message = FALSE}
test_silk <- augment(silk_side.nb, data = choice_side)
resid_silk <- ggplot(test_silk, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_silk$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_silk <- ggplot(test_silk, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

scale_loc_silk <- ggplot(test_silk, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_silk <- ggplot(test_silk, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()


annotate_figure(ggarrange(resid_silk, qq_silk, scale_loc_silk, cook_silk,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Neg Binom Silk"))

test_silk %>% 
  filter(abs(.std.resid) > 3)
```

There are significant outliers, so let's see if removing the outliers changes the results. 

```{r outlers, echo = FALSE, warning = FALSE, message = FALSE}
#removing outliers
choice_side_scaled_filt <- choice_side_scaled %>% 
  filter(! ID == "AP062",
         ! ID == "AP149")
silk_side.nbf <- glm.nb(silk_mass_micro ~ side + mean_leq + Age + condition + side:mean_leq + side:Age + side:condition + side:mean_leq:Age + side: mean_leq:condition, data = choice_side_scaled_filt)
silk_side.nbf <- step(silk_side.nbf)
#drop1(silk_side.nbf, test = "Chisq")
#silk_side.nbf2 <- update(silk_side.nbf, .~. -side:mean_leq:condition)
#drop1(silk_side.nbf2, test = "Chisq")
#silk_side.nbf3 <- update(silk_side.nbf2, .~. -side:condition)
#drop1(silk_side.nbf3, test = "Chisq")
#silk_side.nbf4 <- update(silk_side.nbf3, .~. -condition)
#drop1(silk_side.nbf4, test = "Chisq")
#summary(silk_side.nbf4)
Anova(silk_side.nbf)
```

Same results with or without the outliers (yay!). Let's graph the results.

```{r silk side leq graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred = expand.grid(side = levels(choice_side$side),
                 mean_leq = seq(-1, 1.4, 0.02),
                 Age = quantile(choice_side_scaled$Age, probs = c(0.25, 0.75)))
pred <- add_column(pred, fit = data.frame(predict(silk_side.nb, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(silk_side.nb, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(choice_side$mean_leq) + mean(choice_side$mean_leq)
pred$Age = pred$Age * sd(choice_side$Age) + mean(choice_side$Age)

pred <- pred %>% 
  mutate(side = fct_relevel(side, "quiet", "loud"),
         Age = factor(Age))

choice_side2 <- choice_side %>% 
  mutate(Age = ifelse(Age < median(Age), 15, 32),
         side = fct_relevel(side, "quiet", "loud"),
         Age = factor(Age))

labs <- c("Points: Raw Data < Median Age \nLines: Predictions at 1st Quartile Age",
          "Points: Raw Data >= Median Age \nLines: Predictions at 3rd Quartile Age")
names(labs) <- c("15", "32")

silk_side <- ggplot() +
  geom_point(aes(x = mean_leq, y = silk_mass_micro, color = side), data = choice_side2) +
  geom_line(aes(x = mean_leq, y = fit, color = side), data = pred) +
  geom_ribbon(aes(x = mean_leq, y = fit, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96), fill = side), data = pred, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 2700), breaks = c(0, 500, 1000, 1500, 2000, 2661)) +
  scale_y_break(c(1950, 2600)) +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  ylab("Silk Mass (g)") +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  scale_color_manual("Side", 
                    values = c("#1B9E77", "#D95F02"), 
                    labels = c("Quiet", "Loud")) +
  scale_fill_manual("Side", 
                    values = c("#1B9E77", "#D95F02"), 
                    labels = c("Quiet", "Loud")) +
  th +
  facet_wrap(~Age, labeller = labeller(Age = labs))

jpeg("figures/silk_side.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(silk_side)
dev.off()
silk_side
```

```{r silk side site graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred_8B = expand.grid(Site = "8B",
                Age = seq(5, 50, 0.5),
                side = levels(choice_side_8B$side)) 
pred_8B <- add_column(pred_8B, fit = predict(silk_side.nb_8B, type = "response", newdata = pred_8B),
                      se = predict(silk_side.nb_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit) 

pred_8A = expand.grid(Site = "8A",
                Age = seq(10, 45, 0.5),
                side = levels(choice_side_8A$side))
pred_8A <- add_column(pred_8A, fit = predict(silk_side.nb_8A, type = "response", newdata = pred_8A),
                      se = predict(silk_side.nb_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit)

pred_6C = expand.grid(Site = "6C",
                Age = seq(10, 45, 0.5),
                side = levels(choice_side_6C$side))
pred_6C <- add_column(pred_6C, fit = predict(silk_side.nb_6C, type = "response", newdata = pred_6C),
                      se = predict(silk_side.nb_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit) 

pred_5A = expand.grid(Site = "5A",
                Age = seq(0, 45, 0.5),
                side = levels(choice_side_5A$side))
pred_5A <- add_column(pred_5A, fit = predict(silk_side.nb_5A, type = "response", newdata = pred_5A),
                      se = predict(silk_side.nb_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit) 


pred <- rbind(pred_8B, pred_8A, pred_6C, pred_5A) #pred_all
pred <- pred %>% 
  mutate(side = fct_relevel(side, "quiet", "loud"))
choice_side <- choice_side %>% 
  mutate(side = fct_relevel(side, "quiet", "loud"))

silk_site <- ggplot() +
  geom_point(aes(x = Age, y = silk_mass_micro, color = side), data = choice_side) +
  geom_line(aes(x = Age, y = fit, color = side), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96), fill = side), data = pred, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 50), breaks = c(0, 10, 20, 30, 40, 50)) +
  scale_y_continuous(limits = c(0, 2700), breaks = c(0, 500, 1000, 1500, 2000, 2500), expand = c(0,0 )) +
  scale_color_manual("Side", 
                    values = c("#1B9E77", "#D95F02"), 
                    labels = c("Quiet", "Loud")) +
  scale_fill_manual("Side", 
                    values = c("#1B9E77", "#D95F02"), 
                    labels = c("Quiet", "Loud")) +
  xlab("Age (Days since Maturation)") +
  ylab("Silk Mass (g)") +
  th +
  facet_wrap(~Site)

jpeg("figures/silk_site.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(silk_site)
dev.off()
silk_site
```

## Amount of Silk on Each Side and Tunnel

```{r get silk part data, echo = FALSE, warning = FALSE, message = FALSE}
choice_side2 <- choice %>% 
  dplyr::select(ID, Age, condition, mean_leq, Site, Origin, loud_silk_v, quiet_silk_v, tunnel_silk_v) %>% 
 pivot_longer(cols = c(loud_silk_v, quiet_silk_v, tunnel_silk_v), names_to = "part", values_to = "silk_mass") %>%
  mutate(part = fct_recode(part, "loud" = "loud_silk_v", "quiet" = "quiet_silk_v", "tunnel" = "tunnel_silk_v"),
         part = fct_relevel(part, "loud", "quiet", "tunnel"),
         silk_mass_nano = round(silk_mass * 1000), 0)

choice_side2_scaled <- choice_side2 %>% 
  mutate(mean_leq = c(scale(mean_leq)),
         Age = c(scale(Age)),
         condition = c(scale(condition)))
```

```{r silk part stats, echo = FALSE, warning = FALSE, message = FALSE}
silk_sidet.nb <- glm.nb(silk_mass_nano ~ part + mean_leq + Age + condition + part:mean_leq + part:Age + part:condition + part:mean_leq:Age + part: mean_leq:condition, data = choice_side2_scaled)
silk_sidet.nb <- step(silk_sidet.nb)
Anova(silk_sidet.nb)
lsmeans(silk_sidet.nb, pairwise ~ part)
lstrends(silk_sidet.nb, pairwise ~ part, var = "mean_leq")
lstrends(silk_sidet.nb, pairwise ~ part, var = "mean_leq")
lstrends(silk_sidet.nb, pairwise ~ part, var = "Age", at = list(mean_leq = min(choice_side2_scaled$mean_leq)))
lstrends(silk_sidet.nb, pairwise ~ part, var = "Age", at = list(mean_leq = median(choice_side2_scaled$mean_leq)))
lstrends(silk_sidet.nb, pairwise ~ part, var = "Age", at = list(mean_leq = max(choice_side2_scaled$mean_leq)))

silk_sidet.nb <- glmer.nb(silk_mass_nano ~ part + mean_leq + Age + condition + part:mean_leq + part:Age + part:condition + part:mean_leq:Age + part: mean_leq:condition + (1|ID), data = choice_side2_scaled)
#drop1(silk_sidet.nb, test = "Chisq")
silk_sidet.nb2 <- update(silk_sidet.nb, .~. -part:mean_leq:condition)
#drop1(silk_sidet.nb2, test = "Chisq")
silk_sidet.nb3 <- update(silk_sidet.nb2, .~. -part:condition)
#drop1(silk_sidet.nb3, test = "Chisq")
silk_sidet.nb4 <- update(silk_sidet.nb3, .~. -condition)
#drop1(silk_sidet.nb4, test = "Chisq")
silk_sidet.nb5 <- update(silk_sidet.nb4, .~. -part:mean_leq:Age)
#drop1(silk_sidet.nb5, test = "Chisq")
silk_sidet.nb6 <- update(silk_sidet.nb5, .~. -part:Age)
#drop1(silk_sidet.nb6, test = "Chisq")
silk_sidet.nb7 <- update(silk_sidet.nb6, .~. -part:mean_leq)
#drop1(silk_sidet.nb7, test = "Chisq")
silk_sidet.nb8 <- update(silk_sidet.nb7, .~. -mean_leq)
#drop1(silk_sidet.nb8, test = "Chisq")
Anova(silk_sidet.nb8)
```

```{r silk part stats by site, echo = FALSE, warning = FALSE, message = FALSE}
choice_side2_scaled_8B <- choice_side2_scaled %>% 
  filter(Site == "8B")
silk_sidet.nb_8B <- glm.nb(silk_mass_nano ~ part * Age, data = choice_side2_scaled_8B)
coef_8B <- data.frame(Anova(silk_sidet.nb_8B),
                      Site = "8B",
                      mean_leq = -55) # age and part and int (trend)
lsmeans(silk_sidet.nb_8B, pairwise ~ part) # more in tunnel than loud and quiet
lstrends(silk_sidet.nb_8B, pairwise ~ part, var = "Age") # loud quiet int

choice_side2_scaled_8A <- choice_side2_scaled %>% 
  filter(Site == "8A")
silk_sidet.nb_8A <- glm.nb(silk_mass_nano ~ part * Age, data = choice_side2_scaled_8A)
coef_8A <- data.frame(Anova(silk_sidet.nb_8A),
                      Site = "8A",
                      mean_leq = -64) # none
lsmeans(silk_sidet.nb_8A, pairwise ~ part) # none
lstrends(silk_sidet.nb_8A, pairwise ~ part, var = "Age") #none

choice_side2_scaled_6C <- choice_side2_scaled %>% 
  filter(Site == "6C")
silk_sidet.nb_6C <- glm.nb(silk_mass_nano ~ part * Age, data = choice_side2_scaled_6C)
coef_6C <- data.frame(Anova(silk_sidet.nb_6C),
                      Site = "6C",
                      mean_leq = -69) # age and part
lsmeans(silk_sidet.nb_6C, pairwise ~ part) # more in tunnel than loud
lstrends(silk_sidet.nb_6C, pairwise ~ part, var = "Age") #none

choice_side2_scaled_5A <- choice_side2_scaled %>% 
  filter(Site == "5A")
silk_sidet.nb_5A <- glm.nb(silk_mass_nano ~ part * Age, data = choice_side2_scaled_5A)
coef_5A <- data.frame(Anova(silk_sidet.nb_5A),
                      Site = "5A",
                      mean_leq = -69) # part
lsmeans(silk_sidet.nb_5A, pairwise ~ part) # more in tunnel than quiet, trend loud
lstrends(silk_sidet.nb_5A, pairwise ~ part, var = "Age") #none

rbind(coef_8B, coef_8A, coef_6C, coef_5A)
```

```{r silk part graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
silk_sidet.nb <- glm.nb(silk_mass_nano ~ part + mean_leq + Age + condition + part:mean_leq + part:Age + part:condition + part:mean_leq:Age + part: mean_leq:condition, data = choice_side2_scaled)
silk_sidet.nb <- step(silk_sidet.nb)

pred = expand.grid(part = levels(choice_side2$part),
                 mean_leq = seq(-1, 1.4, 0.02),
                 Age = quantile(choice_side2_scaled$Age, probs = c(0.25, 0.75)))
pred <- add_column(pred, fit = data.frame(predict(silk_sidet.nb, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(silk_sidet.nb, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(choice_side2$mean_leq) + mean(choice_side2$mean_leq)
pred$Age = pred$Age * sd(choice_side2$Age) + mean(choice_side2$Age)

pred <- pred %>% 
  mutate(side = fct_relevel(part, "quiet", "loud", "tunnel"),
         Age = factor(Age))

choice_side3 <- choice_side2 %>% 
  mutate(Age = ifelse(Age < median(Age), 15, 32),
         part = fct_relevel(part, "quiet", "loud", "tunnel"),
         Age = factor(Age))

labs <- c("Points: Raw Data < Median Age \nLines: Predictions at 1st Quartile Age",
          "Points: Raw Data >= Median Age \nLines: Predictions at 3rd Quartile Age")
names(labs) <- c("15", "32")

ggplot() +
  geom_point(aes(x = mean_leq, y = silk_mass_nano, color = part), data = choice_side3) +
  geom_line(aes(x = mean_leq, y = fit, color = part), data = pred) +
  geom_ribbon(aes(x = mean_leq, y = fit, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96), fill = part), data = pred, alpha = 0.5) +
  scale_x_continuous(breaks = c(-69, -64, -55)) +
  ylab("Silk Mass (g)") +
  xlab("Site Average Leq (dB, 20-1000 Hz)") +
  scale_color_manual("Part", 
                    values = c("#1B9E77", "#D95F02", "#666666"), 
                    labels = c("Quiet", "Loud", "Tunnel")) +
  scale_fill_manual("Part", 
                    values = c("#1B9E77", "#D95F02", "#666666"), 
                    labels = c("Quiet", "Loud", "Tunnel")) +
  th +
  facet_wrap(~Age, labeller = labeller(Age = labs))



pred = expand.grid(part = levels(choice_side2$part),
                 mean_leq = quantile(choice_side2_scaled$mean_leq, probs = c(0, 0.5, 1)),
                 Age = seq(-2.5, 2.5, 0.05))
pred <- add_column(pred, fit = data.frame(predict(silk_sidet.nb, newdata = pred, type = "response", se.fit = TRUE))$fit,
                  se = data.frame(predict(silk_sidet.nb, newdata = pred, type = "response", se.fit = TRUE))$se.fit )
# back transform
pred$mean_leq = pred$mean_leq * sd(choice_side2$mean_leq) + mean(choice_side2$mean_leq)
pred$Age = pred$Age * sd(choice_side2$Age) + mean(choice_side2$Age)

silk_side2 <- ggplot() +
  geom_point(aes(x = Age, y = silk_mass_nano, color = part), data = choice_side2) +
  geom_line(aes(x = Age, y = fit, color = part), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (se), ymax = fit + (se), fill = part), data = pred, alpha = 0.5) +
  ylab(bquote('Silk Mass '(ng/cm^3))) +
  xlab("Age (Days Since Mature)") +
  scale_color_manual("Part", 
                    values = c("#D95F02", "#1B9E77", "#666666"), 
                    labels = c("Loud", "Quiet", "Tunnel")) +
  scale_fill_manual("Part", 
                    values = c("#D95F02", "#1B9E77", "#666666"), 
                    labels = c("Loud", "Quiet", "Tunnel")) +
  th +
  facet_wrap(~ mean_leq, labeller = labeller(mean_leq = c("-69" = "Leq: -69 dB", "-64" = "Leq: -64 dB", "-55" = "Leq: -55 dB")))

jpeg("figures/silk_side2.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(silk_side2)
dev.off()
silk_side2
```

```{r silk part by site graph, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
pred_8B = expand.grid(Site = "8B",
                Age = seq(-2.5, 2.5, 0.1),
                part = levels(choice_side2$part)) 
pred_8B <- add_column(pred_8B, fit = predict(silk_sidet.nb_8B, type = "response", newdata = pred_8B),
                      se = predict(silk_sidet.nb_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit) 


pred_8A = expand.grid(Site = "8A",
                Age = seq(-2.5, 2.5, 0.1),
                part = levels(choice_side2$part))
pred_8A <- add_column(pred_8A, fit = predict(silk_sidet.nb_8A, type = "response", newdata = pred_8A),
                      se = predict(silk_sidet.nb_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit)

pred_6C = expand.grid(Site = "6C",
                Age = seq(-2.5, 2.5, 0.1),
                part = levels(choice_side2$part))
pred_6C <- add_column(pred_6C, fit = predict(silk_sidet.nb_6C, type = "response", newdata = pred_6C),
                      se = predict(silk_sidet.nb_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit) 

pred_5A = expand.grid(Site = "5A",
                Age = seq(-2.5, 2.5, 0.1),
                part = levels(choice_side2$part))
pred_5A <- add_column(pred_5A, fit = predict(silk_sidet.nb_5A, type = "response", newdata = pred_5A),
                      se = predict(silk_sidet.nb_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit) 


pred <- rbind(pred_8B, pred_8A, pred_6C, pred_5A) #pred_all
pred$Age = pred$Age * sd(choice_side2$Age) + mean(choice_side2$Age)
pred <- pred %>% 
  mutate(part = fct_relevel(part, "quiet", "loud", "tunnel"))
choice_side2 <- choice_side2 %>% 
  mutate(part = fct_relevel(part, "quiet", "loud", "tunnel"))

silk_site2 <- ggplot() +
  geom_point(aes(x = Age, y = silk_mass_nano, color = part), data = choice_side2) +
  geom_line(aes(x = Age, y = fit, color = part), data = pred) +
  geom_ribbon(aes(x = Age, y = fit, ymin = fit - (se * 1.96), ymax = fit + (se * 1.96), fill = part), data = pred, alpha = 0.5) +
  scale_x_continuous(limits = c(0, 50), breaks = c(0, 10, 20, 30, 40, 50)) +
  #scale_y_continuous(limits = c(0, 2700), breaks = c(0, 500, 1000, 1500, 2000, 2500), expand = c(0,0 )) +
  scale_color_manual("Part", 
                    values = c("#1B9E77", "#D95F02", "#666666"), 
                    labels = c("Quiet", "Loud", "Tunnel")) +
  scale_fill_manual("Part", 
                    values = c("#1B9E77", "#D95F02", "#666666"), 
                    labels = c("Quiet", "Loud", "Tunnel")) +
  xlab("Age (Days since Maturation)") +
  ylab("Silk Mass (g)") +
  th +
  facet_wrap(~Site)

jpeg("figures/silk_site2.jpeg", width = 6.5, height = 4, units = "in", quality = 100, res = 300)
print(silk_site2)
dev.off()
silk_site2
```

## Proportional Difference

**tl;dr:** We subtracted the proportion of one side from the proportion of the other as a measure of decisiveness and tested it with a beta regression. A trend showed decreasing decisiveness with increasing origin leq. Rural spiders were significantly more decisive.

We can get an idea of how decisive the spiders are by substracting the proportion of silk on one side from the proportion of silk on the other and taking the absolute value. This value ranges from indecisive 0 (50:50 silk each side) to completely decisive 1 (100:0 silk on each side), so we will use a beta regression.

```{r diff exploration, echo = FALSE, message = FALSE, warning = FALSE}
mean_leq_raw <- choice %>% 
    ggplot() +
  geom_point(aes(x = mean_leq, y = prop_diff, color = factor(mean_leq))) +
  geom_smooth(aes(x = mean_leq, y = prop_diff), color = "black") +
  theme(legend.position = "top")

Age_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = Age, y = prop_diff, color = factor(mean_leq))) +
  geom_smooth(aes(x = Age, y = prop_diff), color = "black") +
  theme(legend.position = "top")

condition_raw <- choice %>% 
  ggplot() +
  geom_point(aes(x = condition, y = prop_diff, color = factor(mean_leq))) +
  geom_smooth(aes(x = condition, y = prop_diff), color = "black") +
  theme(legend.position = "top")

ggarrange(Age_raw, condition_raw, mean_leq_raw, nrow = 2, ncol = 2)
```

```{r diff leq, echo = FALSE, warning = FALSE, message = FALSE}
# proportion difference without tunnel
#summary(buildglmmTMB(prop_diff ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit")))

model.beta.gam.diff <- gam(prop_diff ~ mean_leq, data = choice_scaled, family = betar(link = "logit"))
summary(model.beta.gam.diff)

#summary(buildglmmTMB(prop_diff ~ Origin * Age + Origin * condition, data = choice_scaled, family = list(family = "beta", link = "logit")))

model.beta.gam.diff2 <- gam(prop_diff ~ Origin, data = choice_scaled, family = betar(link = "logit"))
summary(model.beta.gam.diff2)

# proportion difference with tunnel
#summary(buildglmmTMB(prop_diff_tunnel ~ mean_leq * Age + mean_leq * condition, data = choice_scaled, family = list(family = "beta", link = "logit")))

model.beta.gam.diff3 <- gam(prop_diff_tunnel ~ mean_leq, data = choice_scaled, family = betar(link = "logit"))
summary(model.beta.gam.diff3)

#summary(buildglmmTMB(prop_diff_tunnel ~ Origin * Age + Origin * condition, data = choice_scaled, family = list(family = "beta", link = "logit")))

model.beta.gam.diff4 <- gam(prop_diff_tunnel ~ Origin, data = choice_scaled, family = betar(link = "logit"))
summary(model.beta.gam.diff4)
```

Let's also see how each site is responding. 

```{r diff site, echo = FALSE, warning = FALSE, message = FALSE}
#beta_leq_gam_8B <- gam(prop_diff ~ side_w_more, data = choice_8B, family = betar(link = "logit"))
beta_leq_gam_8B <- gam(prop_diff ~ 1, data = choice_8B, family = betar(link = "logit"))
coef_beta_8B <- round(data.frame(estimates = summary(beta_leq_gam_8B)$p.coeff,
                                 se = summary(beta_leq_gam_8B)$se,
                                 z = summary(beta_leq_gam_8B)$p.t,
                                 p = summary(beta_leq_gam_8B)$p.pv),
                                 3) %>% 
  mutate(Site = "8B",
         Leq = -55)

#beta_leq_gam_8A <- gam(prop_diff ~ side_w_more, data = choice_8A, family = betar(link = "logit"))
beta_leq_gam_8A <- gam(prop_diff ~ 1, data = choice_8A, family = betar(link = "logit"))
coef_beta_8A <- round(data.frame(estimates = summary(beta_leq_gam_8A)$p.coeff,
                                 se = summary(beta_leq_gam_8A)$se,
                                 z = summary(beta_leq_gam_8A)$p.t,
                                 p = summary(beta_leq_gam_8A)$p.pv),
                                 3) %>% 
  mutate(Site = "8A",
         Leq = -64)

#beta_leq_gam_6C <- gam(prop_diff ~ side_w_more, data = choice_6C, family = betar(link = "logit"))
beta_leq_gam_6C <- gam(prop_diff ~ 1, data = choice_6C, family = betar(link = "logit"))
coef_beta_6C <- round(data.frame(estimates = summary(beta_leq_gam_6C)$p.coeff,
                                 se = summary(beta_leq_gam_6C)$se,
                                 z = summary(beta_leq_gam_6C)$p.t,
                                 p = summary(beta_leq_gam_6C)$p.pv),
                                 3) %>% 
  mutate(Site = "6C",
         Leq = -69)

#beta_leq_gam_5A <- gam(prop_diff ~ side_w_more, data = choice_5A, family = betar(link = "logit"))
beta_leq_gam_5A <- gam(prop_diff ~ 1, data = choice_5A, family = betar(link = "logit"))
coef_beta_5A <- round(data.frame(estimates = summary(beta_leq_gam_5A)$p.coeff,
                                 se = summary(beta_leq_gam_5A)$se,
                                 z = summary(beta_leq_gam_5A)$p.t,
                                 p = summary(beta_leq_gam_5A)$p.pv),
                                 3) %>% 
  mutate(Site = "5A",
         Leq = -69)

rbind(coef_beta_8B, coef_beta_8A, coef_beta_6C, coef_beta_5A)
```

5A is most decisive and 8A is least decisive. 

```{r beta diff assumptions, echo = FALSE,  warning = FALSE, message = FALSE}
test_beta <- augment(model.beta.gam.diff2, data = choice_scaled)
resid_beta <- ggplot(test_beta, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_smooth() +
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Standardized \nResiduals") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Residual vs Fitted Plot")

y <- quantile(test_beta$.resid, c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

qq_beta <- ggplot(test_beta, aes(sample = .resid)) + 
  stat_qq() + 
  geom_abline(slope = slope, intercept = int) +
  xlab("Theoretical Quantiles") +
  ylab("Sample Quantiles") +
  theme_classic() +
  theme(text = element_text(size = 14, color = "black")) +
  theme(axis.text.x=element_text(color="black", size=14)) + 
  theme(axis.text.y=element_text(color="black", size=14)) +
  ggtitle("Normal Q-Q")

test_beta$.std.resid <- residuals(beta_leq_gam, type = "deviance")
scale_loc_beta <- ggplot(test_beta, aes(x = .fitted, y = sqrt(abs(.std.resid)))) + 
  geom_point(na.rm=TRUE) +
  geom_hline(yintercept = 0.8) +
  stat_smooth(method="loess", na.rm = TRUE) +
  xlab("Fitted Value") +
  ylab(expression(sqrt("|Standardized residuals|"))) +
  ggtitle("Scale-Location") 

cook_beta <- ggplot(test_beta, aes(seq_along(.cooksd), .cooksd)) +
  geom_bar(stat="identity", position="identity") +
  xlab("Obs. Number") +
  ylab("Cook's distance") +
  ggtitle("Cook's distance") +
  theme_bw()


annotate_figure(ggarrange(resid_beta, qq_beta, scale_loc_beta, cook_beta,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2), top = text_grob("Beta Prop Silk"))

test_beta %>% 
  filter(abs(.std.resid) > 3)
```

```{r beta diff leq graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
pred <- expand.grid(Origin = levels(choice$Origin))
pred <- add_column(pred, fit = predict(model.beta.gam.diff2, newdata = pred, type = "response"),
                 se = predict(model.beta.gam.diff2, newdata = pred, type = "response", se.fit = TRUE)$se.fit)

val <- data.frame(Origin = c("Rural", "Urban"),
                  prop_diff = c(0.4365174, 0.3114728),
                  prop = c("72:28", "66:34"))

diff_origin <- ggplot() +
  geom_point(aes(x=Origin, y = prop_diff), data = choice, alpha = 0.75, color = "grey20") +
  geom_point(aes(x = Origin, y = fit), data = pred, size = 1.5, position = position_nudge(0.25)) +
  geom_errorbar(aes(x = Origin, ymin = fit - (se * 1.), ymax = fit + (se * 1.)), data = pred, width = 0.15, position = position_nudge(0.25)) +
  geom_text(aes(x = Origin, y = prop_diff, label = prop), data = val, position = position_nudge(0.4), size = 3) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.2, 0.5, 0.8, 1), labels = c("50:50", "60:40", "75:25", "90:10", "100:0")) +
  xlab("Origin") +
  ylab("Proportional Difference Between Sides") +
  th 

jpeg("figures/diff_origin.jpeg", width = 4, height = 4, units = "in", quality = 100, res = 300)
print(diff_origin)
dev.off()
diff_origin
```

```{r beta diff site graph, echo = FALSE,  warning = FALSE, message = FALSE, results = 'hide'}
pred_8B = expand.grid(Site = "8B")
pred_8B <- add_column(pred_8B, fit = predict(beta_leq_gam_8B, type = "response", newdata = pred_8B),
                      se = predict(beta_leq_gam_8B, type = "response", newdata = pred_8B, se.fit = TRUE)$se.fit)

pred_8A = expand.grid(Site = "8A")
pred_8A <- add_column(pred_8A, fit = predict(beta_leq_gam_8A, type = "response", newdata = pred_8A),
                      se = predict(beta_leq_gam_8A, type = "response", newdata = pred_8A, se.fit = TRUE)$se.fit) 

pred_6C = expand.grid(Site = "6C")
pred_6C <- add_column(pred_6C, fit = predict(beta_leq_gam_6C, type = "response", newdata = pred_6C),
                      se = predict(beta_leq_gam_6C, type = "response", newdata = pred_6C, se.fit = TRUE)$se.fit)

pred_5A = expand.grid(Site = "5A")
pred_5A <- add_column(pred_5A, fit = predict(beta_leq_gam_5A, type = "response", newdata = pred_5A),
                      se = predict(beta_leq_gam_5A, type = "response", newdata = pred_5A, se.fit = TRUE)$se.fit)

pred <- rbind(pred_5A, pred_6C, pred_8A, pred_8B)

val <- data.frame(Site = c("5A", "6C", "8A", "8B"),
                  prop_diff = c(0.4729891, 0.3906049, 0.2701301, 0.3359091),
                  prop = c("74:26", "70:30", "64:36", "67:33"))


diff_site <- ggplot() +
  geom_point(aes(x=Site, y = prop_diff), data = choice, alpha = 0.75, color = "grey20") +
  geom_point(aes(x = Site, y = fit), data = pred, size = 1.5, position = position_nudge(0.25)) +
  geom_errorbar(aes(x = Site, ymin = fit - (se * 1.), ymax = fit + (se * 1.)), data = pred, width = 0.15, position = position_nudge(0.25)) +
  geom_text(aes(x = Site, y = prop_diff, label = prop), data = val, position = position_nudge(0.5), size = 3) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.2, 0.5, 0.8, 1), labels = c("50:50", "60:40", "75:25", "90:10", "100:0")) +
  scale_x_discrete(labels = c("5A" = "5A \n(-69 dB)", "6C" = "6C \n(-69 dB)", "8A" = "8A \n(-64 dB)", "8B" = "8B \n(-55 dB)")) +
  xlab("Site") +
  ylab("Proportional Difference Between Sides") +
  th 

jpeg("figures/diff_site.jpeg", width = 4, height = 4, units = "in", quality = 100, res = 300)
print(diff_site)
dev.off()
diff_site


choice3 <- choice %>% 
  mutate(abs_diff = propl - (1-propl)) %>% 
  group_by(Site, side_w_more) %>% 
  summarize(mean = mean(abs_diff),
            se = plotrix::std.error(abs_diff))

choice %>% 
  # above zero is more in loud and below zero is more in quiet
  mutate(abs_diff = propl - (1-propl)) %>% 
ggplot() +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = 1), fill = "#D95F02", alpha = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -1, ymax = 0), fill = "#1B9E77", alpha = 0.5) +
  geom_point(aes(x=Site, y = abs_diff), alpha = 0.75, color = "grey20") +
  geom_point(aes(x = Site, y = mean), size = 1.5, data = choice3, position = position_nudge(0.25)) +
  geom_errorbar(aes(x = Site, y = mean, ymin = mean - se, ymax = mean + se), width = 0.15, data = choice3, position = position_nudge(0.25)) +
  geom_hline(yintercept = 0, linetype = 2) +
  xlab("Site") +
  ylab("Proportional Difference Between Sides") +
  th
```
